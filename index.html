<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Workspace v5.0</title>
    <style>
        /* --- ÂÖ®‰ΩìË®≠ÂÆö --- */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #1a202c;
            background-image: radial-gradient(#2d3748 1px, transparent 1px);
            background-size: 20px 20px;
            color: #e2e8f0; margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- „Éò„ÉÉ„ÉÄ„Éº --- */
        header {
            background-color: #171923; border-bottom: 1px solid #4a5568;
            padding: 0 10px; height: 50px; display: flex; align-items: center;
            gap: 10px; flex-shrink: 0; z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); overflow-x: auto; white-space: nowrap;
        }
        header::-webkit-scrollbar { display: none; } 
        h1 { font-size: 1rem; color: #a0aec0; margin-right: auto; font-weight: normal; margin-left: 5px;}

        /* --- „Éú„Çø„É≥È°û --- */
        .control-group {
            display: flex; align-items: center; gap: 8px;
            background-color: #2d3748; padding: 4px 8px;
            border-radius: 4px; border: 1px solid #4a5568;
        }
        .btn-control {
            background-color: #2b6cb0; color: white; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 0.8rem; transition: all 0.2s;
        }
        .btn-control:hover { background-color: #3182ce; }
        .btn-control:disabled { background-color: #4a5568; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background-color: #9b2c2c; }
        .btn-cloud { background-color: #d69e2e; color: #1a202c; font-weight: bold; }
        .btn-cloud:hover { background-color: #ecc94b; }

        .switch-label { font-size: 0.75rem; color: #cbd5e0; cursor: pointer; user-select: none; margin-left: 5px;}
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #4a5568; transition: .4s; border-radius: 16px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(14px); }

        #status-indicator { font-size: 0.75rem; color: #ecc94b; min-width: 50px; text-align: right; margin-right: 5px;}
        #status-indicator.saved { color: #48bb78; }
        #status-indicator.error { color: #f56565; }

        /* --- „Ç≠„É£„É≥„Éê„Çπ --- */
        #canvas {
            position: relative; flex-grow: 1; width: 100%; height: 100%;
            overflow: auto; /* PC„Åß„ÇÇ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å´ */
        }

        /* --- „Ç¶„Ç£„É≥„Éâ„Ç¶ (PC„Éá„Éï„Ç©„É´„Éà) --- */
        .window {
            position: absolute; background-color: #222630;
            border: 1px solid #4a5568; border-radius: 6px;
            display: flex; flex-direction: column;
            width: 320px; height: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            resize: both; overflow: hidden; /* PC„ÅØÁ∏¶Ê®™„É™„Çµ„Ç§„Ç∫ */
            transition: border-color 0.2s, box-shadow 0.2s;
            min-width: 200px; min-height: 150px;
        }
        .window.active { border-color: #63b3ed; box-shadow: 0 15px 35px rgba(0,0,0,0.7); }
        
        .win-header {
            padding: 8px 12px; background-color: #2d3748; border-bottom: 1px solid #4a5568;
            display: flex; justify-content: space-between; align-items: center;
            cursor: move; user-select: none; flex-shrink: 0;
        }
        .win-title { font-size: 0.85rem; font-weight: bold; color: #e2e8f0; }
        .btn-delete { background: none; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; line-height: 1; }
        
        .win-body { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        .win-tools { 
            padding: 5px 10px; background-color: #1a202c; display: flex; align-items: center; 
            gap: 5px; flex-shrink: 0; border-bottom: 1px solid #2d3748;
        }
        
        textarea {
            flex-grow: 1; width: 100%; background-color: #222630; color: #e2e8f0;
            border: none; padding: 10px; resize: none; line-height: 1.7; outline: none;
            box-sizing: border-box; 
        }
        
        /* „ÉÑ„Éº„É´„Éú„Çø„É≥ */
        .btn-tool { cursor: pointer; border: none; color: #e2e8f0; background-color: #4a5568; border-radius: 3px; padding: 3px 8px; font-size: 0.75rem; }
        .btn-tool:hover { background-color: #718096; }
        .btn-font { font-family: monospace; font-weight: bold; width: 30px; }

        .btn-format { width: 100%; background-color: #553c9a; color: #e9d8fd; border: none; border-top: 1px solid #4a5568; padding: 10px; font-weight: bold; flex-shrink: 0; cursor: pointer;}
        .btn-format:hover { background-color: #6b46c1; }

        /* „É°„Éá„Ç£„Ç¢„É¨„Ç§„É§„Éº */
        .media-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #000;
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }
        .media-layer.show { display: flex; }
        .media-content { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-close-media {
            position: absolute; top: 10px; right: 10px; background-color: rgba(0,0,0,0.6);
            color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 4px 10px; cursor: pointer;
        }

        /* --- „Çπ„Éû„ÉõÁî®„É¨„Çπ„Éù„É≥„Ç∑„Éñ (768px‰ª•‰∏ã) --- */
        @media (max-width: 768px) {
            h1 { display: none; }
            header { gap: 8px; padding: 0 8px; }
            .btn-control { padding: 6px 8px; font-size: 0.75rem; }
            
            #canvas {
                padding: 10px; box-sizing: border-box;
                display: flex; flex-direction: column; gap: 20px; 
                overflow-y: auto; 
            }
            .window {
                /* „Çπ„Éû„Éõ„ÅØÁõ∏ÂØæÈÖçÁΩÆ„ÅßÁ∏¶‰∏¶„Å≥ */
                position: relative !important; left: auto !important; top: auto !important;
                width: 100% !important; 
                /* È´ò„Åï„ÅØJS„ÅßÂà∂Âæ°„Åô„Çã„Åå„ÄÅCSS„Åß„ÅÆ„É™„Çµ„Ç§„Ç∫„ÇíË®±ÂèØÔºàÁ∏¶„ÅÆ„ÅøÔºâ */
                resize: vertical !important; 
                margin-bottom: 0; z-index: 1 !important; flex-shrink: 0;
            }
            .win-header { cursor: default; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Canvas v5.0</h1>
        <span id="status-indicator">Ready</span>

        <button class="btn-control btn-cloud" onclick="uploadToCloud()">‚òÅÔ∏è UP</button>
        <button class="btn-control btn-cloud" onclick="downloadFromCloud()">‚òÅÔ∏è DOWN</button>

        <div class="control-group">
            <label class="switch">
                <input type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()">
                <span class="slider"></span>
            </label>
            <label for="autoSaveToggle" class="switch-label">Auto</label>
        </div>

        <button class="btn-control" id="btn-manual-save" onclick="manualSaveAll()">üíæ ‰øùÂ≠ò</button>
        <button class="btn-control" onclick="createNewWindow()">Ôºã</button>
        <button class="btn-control btn-danger" onclick="clearAllData()">üóëÔ∏è</button>
        
        <div style="width:10px;"></div>
        <div class="control-group">
             <label class="switch">
                <input type="checkbox" id="syncToggle">
                <span class="slider"></span>
            </label>
            <label for="syncToggle" class="switch-label">ÈÄ£Âãï</label>
        </div>
    </header>

    <div id="canvas"></div>

    <script>
        // ==========================================
        //  GAS URL (POSTÂØæÂøúÁâà)
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyCsdPclvOpyEyxB4fEklillB729ge_b9-q9afAZPartKazdS9-6u8xkfDercVRaLl2/exec"; 
        // ==========================================

        const DB_NAME = 'CreativeWorkspaceDB_v5';
        const DB_VERSION = 2; // „Éê„Éº„Ç∏„Éß„É≥„Ç¢„ÉÉ„ÉóÔºàsettings„Çπ„Éà„Ç¢ËøΩÂä†„ÅÆ„Åü„ÇÅÔºâ
        const STORE_WINDOWS = 'windows';
        const STORE_SETTINGS = 'settings';

        let db = null;
        let zIndexCounter = 100;
        let isAutoSaveEnabled = false;
        let isSaving = false;
        let saveTimers = {};
        let blobCache = {};

        window.onload = async function() {
            await initDB();
            loadFromDB();
        };

        // --- Auth (IndexedDB„Å´‰øùÂ≠ò) ---
        async function getAuthPassword() {
            // 1. DB„Åã„ÇâÂèñÂæóË©¶Ë°å
            try {
                const tx = db.transaction([STORE_SETTINGS], 'readonly');
                const req = tx.objectStore(STORE_SETTINGS).get('auth_password');
                const res = await new Promise(r => req.onsuccess = () => r(req.result));
                if (res && res.value) return res.value;
            } catch(e) { console.error(e); }

            // 2. „Å™„Åë„Çå„Å∞ÂÖ•Âäõ
            const pass = prompt("„Çª„Ç≠„É•„É™„ÉÜ„Ç£‰øùË≠∑„ÅÆ„Åü„ÇÅ„ÄÅÂêàË®ÄËëâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            if (pass) {
                // ‰øùÂ≠ò
                const tx = db.transaction([STORE_SETTINGS], 'readwrite');
                tx.objectStore(STORE_SETTINGS).put({ key: 'auth_password', value: pass });
            }
            return pass;
        }

        async function clearAuthPassword() {
            const tx = db.transaction([STORE_SETTINGS], 'readwrite');
            tx.objectStore(STORE_SETTINGS).delete('auth_password');
        }

        // --- Cloud Logic (SyncÂâç„ÅÆ‰øùÂ≠ò„ÄÅAuth‰øùÂ≠ò„ÄÅPOSTÈÄö‰ø°) ---
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        async function base64ToBlob(base64) {
            const res = await fetch(base64);
            return await res.blob();
        }

        async function uploadToCloud() {
            // 1. „Åæ„Åö„É≠„Éº„Ç´„É´‰øùÂ≠ò
            await manualSaveAll();

            const pass = await getAuthPassword();
            if (!pass) return alert("ÂêàË®ÄËëâ„ÅåÂøÖË¶Å„Åß„Åô‰∏≠Ê≠¢„Åó„Åæ„Åô");

            if(!confirm("„ÇØ„É©„Ç¶„Éâ(Google Drive)„Å´‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü\n(Êó¢Â≠ò„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô)")) return;
            updateStatus("Â§âÊèõ‰∏≠...", false);
            
            try {
                const tx = db.transaction([STORE_WINDOWS], 'readonly');
                const req = tx.objectStore(STORE_WINDOWS).getAll();
                const records = await new Promise(r => req.onsuccess = () => r(req.result));

                const exportData = [];
                for(let r of records) {
                    let b64 = null;
                    if(r.hasMedia && r.mediaBlob) {
                        b64 = await blobToBase64(r.mediaBlob);
                    }
                    // „Åù„ÅÆ„Åæ„ÅæÂÖ®„Éó„É≠„Éë„ÉÜ„Ç£ÔºàlayoutPC, layoutMobileÂê´„ÇÄÔºâ„ÇíÂá∫„Åô
                    exportData.push({
                        id: r.id, 
                        layoutPC: r.layoutPC,
                        layoutMobile: r.layoutMobile,
                        fontSize: r.fontSize,
                        text: r.text,
                        hasMedia: r.hasMedia,
                        mediaType: r.mediaType,
                        mediaBase64: b64
                    });
                }

                updateStatus("ÈÄÅ‰ø°‰∏≠...", false);

                // URL„Å´„Éë„É©„É°„Éº„Çø„ÄÅBody„Å´„Éá„Éº„Çø
                const urlWithAuth = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}`;

                const response = await fetch(urlWithAuth, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' }, 
                    body: JSON.stringify(exportData)
                });

                if(!response.ok) throw new Error("HTTP Status: " + response.status);
                const resJson = await response.json();
                
                if(resJson.status === 'success') {
                    updateStatus("UPÂÆå‰∫Ü", true);
                    alert("„ÇØ„É©„Ç¶„Éâ‰øùÂ≠òÂÆå‰∫ÜÔºÅ");
                } else {
                    // ÂêàË®ÄËëâ„Éü„Çπ„Å™„Å©
                    if(resJson.message.includes("ÂêàË®ÄËëâ")) {
                        await clearAuthPassword();
                    }
                    throw new Error(resJson.message);
                }

            } catch(e) {
                console.error(e);
                updateStatus("UPÂ§±Êïó", false, true);
                alert("„Ç®„É©„Éº:\n" + e.message);
            }
        }

        async function downloadFromCloud() {
            // 1. „Åæ„Åö„É≠„Éº„Ç´„É´‰øùÂ≠ò (Âøµ„ÅÆ„Åü„ÇÅ)
            await manualSaveAll();

            const pass = await getAuthPassword();
            if (!pass) return alert("ÂêàË®ÄËëâ„ÅåÂøÖË¶Å„Åß„Åô‰∏≠Ê≠¢„Åó„Åæ„Åô");

            if(!confirm("„ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü\n(ÁèæÂú®„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„ÅØÊ∂à„Åà„Åæ„Åô)")) return;
            updateStatus("Âèó‰ø°‰∏≠...", false);

            try {
                // POST„Åß action=download „ÇíÈÄÅ„Çã
                const urlWithAuth = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&action=download`;
                
                const response = await fetch(urlWithAuth, {
                    method: 'POST',
                    body: "" 
                });

                if(!response.ok) throw new Error("HTTP Status: " + response.status);
                
                const text = await response.text();
                if(text.trim().startsWith("<")) throw new Error("GAS„Åã„ÇâHTML„Ç®„É©„Éº„ÅåËøî„Åï„Çå„Åæ„Åó„Åü„ÄÇ");

                const importData = JSON.parse(text);

                if (importData.status === 'error') {
                    if(importData.message.includes("ÂêàË®ÄËëâ")) {
                        await clearAuthPassword();
                    }
                    throw new Error(importData.message);
                }

                if(!Array.isArray(importData)) throw new Error("„Éá„Éº„ÇøÂΩ¢Âºè„Åå‰∏çÊ≠£„Åã„ÄÅ„Éá„Éº„Çø„ÅåÁ©∫„Åß„Åô");

                updateStatus("Â±ïÈñã‰∏≠...", false);
                await clearAllData(true);

                for(let r of importData) {
                    let blob = null;
                    if(r.hasMedia && r.mediaBase64) {
                        blob = await base64ToBlob(r.mediaBase64);
                    }
                    if(blob) blobCache[r.id] = { blob: blob, type: r.mediaType };

                    // Êóß„Éá„Éº„Çø(v4‰ª•Ââç)„Å®„ÅÆ‰∫íÊèõÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                    let lPC = r.layoutPC;
                    if (!lPC && r.w) { // v4„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÄÅÁõ¥‰∏ã„ÅÆx,y,w,h„ÇíPC„É¨„Ç§„Ç¢„Ç¶„Éà„Å´„Åô„Çã
                        lPC = { x: r.x, y: r.y, w: r.w, h: r.h, z: r.z };
                    }
                    let lMob = r.layoutMobile || { h: '350px' };
                    let fSize = r.fontSize || '14px';

                    const record = {
                        id: r.id, 
                        layoutPC: lPC,
                        layoutMobile: lMob,
                        fontSize: fSize,
                        text: r.text,
                        hasMedia: r.hasMedia,
                        mediaBlob: blob,
                        mediaType: r.mediaType
                    };
                    const tx = db.transaction([STORE_WINDOWS], 'readwrite');
                    tx.objectStore(STORE_WINDOWS).put(record);
                }
                loadFromDB();
                updateStatus("DOWNÂÆå‰∫Ü", true);
                alert("Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºÅ");

            } catch(e) {
                console.error(e);
                updateStatus("DOWNÂ§±Êïó", false, true);
                alert("„Ç®„É©„Éº: " + e.message);
            }
        }

        // --- IndexedDB ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const r = indexedDB.open(DB_NAME, DB_VERSION);
                r.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains(STORE_WINDOWS)) d.createObjectStore(STORE_WINDOWS, { keyPath: 'id' });
                    if (!d.objectStoreNames.contains(STORE_SETTINGS)) d.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                };
                r.onsuccess = (e) => { db = e.target.result; resolve(db); };
                r.onerror = (e) => reject(e);
            });
        }

        async function saveWindowToDB(winId) {
            if (!db) return;
            const el = document.getElementById(winId);
            if (!el) return;
            const idNum = parseInt(winId.split('-')[1]);
            const isMobile = window.innerWidth <= 768;

            const tx = db.transaction([STORE_WINDOWS], 'readonly');
            const old = await new Promise(r => {
                const req = tx.objectStore(STORE_WINDOWS).get(idNum);
                req.onsuccess = () => r(req.result);
            });

            // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
            const rect = el.getBoundingClientRect();
            const ta = el.querySelector('textarea');
            const mediaLayer = document.getElementById(`media-${idNum}`);
            const isMediaShow = mediaLayer.classList.contains('show');
            let blob = null, type = null;
            if (isMediaShow && blobCache[idNum]) {
                blob = blobCache[idNum].blob;
                type = blobCache[idNum].type;
            }

            // Êñ∞„Åó„ÅÑ„Éá„Éº„ÇøÊßãÈÄ†„Çí‰ΩúÊàê
            // Êó¢Â≠ò„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí„Éô„Éº„Çπ„Å´„Åô„Çã
            let layoutPC = old && old.layoutPC ? old.layoutPC : { x:'50px', y:'50px', w:'320px', h:'400px', z:100 };
            let layoutMobile = old && old.layoutMobile ? old.layoutMobile : { h:'350px' };
            let fontSize = el.style.getPropertyValue('--font-size') || (old ? old.fontSize : '14px');

            // ÁîªÈù¢„É¢„Éº„Éâ„Å´Âêà„Çè„Åõ„Å¶„É¨„Ç§„Ç¢„Ç¶„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            if (isMobile) {
                // „Çπ„Éû„ÉõÊôÇÔºöÈ´ò„Åï„ÅÆ„ÅøÊõ¥Êñ∞ (ÂπÖ„ÅØ100%Âõ∫ÂÆö„ÄÅX/YÁÑ°Âäπ)
                // „Çπ„Éû„Éõ„ÅÆ„É™„Çµ„Ç§„Ç∫„ÅØ style.height „Å´ÂèçÊò†„Åï„Çå„Çã
                layoutMobile.h = el.style.height; 
            } else {
                // PCÊôÇÔºöx, y, w, h, z „ÇíÊõ¥Êñ∞
                layoutPC.x = el.style.left;
                layoutPC.y = el.style.top;
                layoutPC.w = el.style.width;
                layoutPC.h = el.style.height;
                layoutPC.z = parseInt(el.style.zIndex || 100);
            }

            const data = {
                id: idNum,
                layoutPC: layoutPC,
                layoutMobile: layoutMobile,
                fontSize: fontSize,
                text: ta.value,
                hasMedia: isMediaShow, mediaBlob: blob, mediaType: type
            };

            return new Promise(res => {
                const tx2 = db.transaction([STORE_WINDOWS], 'readwrite');
                tx2.objectStore(STORE_WINDOWS).put(data);
                tx2.oncomplete = () => { updateStatus('‰øùÂ≠òÊ∏à', true); res(); };
            });
        }

        async function deleteWindowFromDB(idNum) {
            if(!db) return;
            const tx = db.transaction([STORE_WINDOWS], 'readwrite');
            tx.objectStore(STORE_WINDOWS).delete(idNum);
            delete blobCache[idNum];
        }

        async function loadFromDB() {
            if(!db) return;
            document.getElementById('canvas').innerHTML = '';
            const tx = db.transaction([STORE_WINDOWS], 'readonly');
            const req = tx.objectStore(STORE_WINDOWS).getAll();
            req.onsuccess = (e) => {
                const r = e.target.result;
                r.sort((a,b)=>a.id-b.id);
                if(r.length===0){ addWindow(50,50,1); addWindow(400,50,2); }
                else r.forEach(rec => restoreWindow(rec));
                updateStatus('Ready', true);
            };
        }

        async function clearAllData(skip=false) {
            if(!skip && !confirm("ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
            document.getElementById('canvas').innerHTML='';
            blobCache={};
            const tx = db.transaction([STORE_WINDOWS], 'readwrite');
            tx.objectStore(STORE_WINDOWS).clear();
            if(!skip) updateStatus('ÂâäÈô§ÂÆå‰∫Ü', true);
        }

        // --- UI Utils ---
        function toggleAutoSave() {
            isAutoSaveEnabled = document.getElementById('autoSaveToggle').checked;
            document.getElementById('btn-manual-save').disabled = isAutoSaveEnabled;
        }
        function notifyChange(winId) {
            if (!isAutoSaveEnabled) return;
            if (saveTimers[winId]) clearTimeout(saveTimers[winId]);
            updateStatus('Â§âÊõ¥...', false);
            saveTimers[winId] = setTimeout(async () => {
                if(isSaving) { notifyChange(winId); return; }
                isSaving=true;
                try { await saveWindowToDB(winId); } finally { isSaving=false; delete saveTimers[winId]; }
            }, 1000);
        }
        async function manualSaveAll() {
            if(isSaving) return;
            isSaving=true;
            document.getElementById('btn-manual-save').disabled=true;
            updateStatus('‰øùÂ≠ò‰∏≠...', false);
            const wins=document.querySelectorAll('.window');
            for(const w of wins) await saveWindowToDB(w.id);
            isSaving=false;
            updateStatus('‰øùÂ≠òÂÆå‰∫Ü', true);
            if(!isAutoSaveEnabled) document.getElementById('btn-manual-save').disabled=false;
        }
        function updateStatus(m,s,e=false) {
            const el=document.getElementById('status-indicator');
            el.textContent=m; el.className='';
            if(s) el.classList.add('saved');
            if(e) el.classList.add('error');
        }

        // --- Window Operations ---
        function createNewWindow() {
            let max=0;
            document.querySelectorAll('.window').forEach(w=>{
                const id=parseInt(w.id.split('-')[1]);
                if(id>max) max=id;
            });
            addWindow(50,50,max+1);
        }

        function addWindow(x,y,idNum, layoutPC=null, layoutMobile=null, fontSize='14px') {
            const winId='win-'+idNum;
            const isMobile = window.innerWidth <= 768;

            // „É¨„Ç§„Ç¢„Ç¶„ÉàÊ±∫ÂÆö
            let styleStr = "";
            let w = '320px', h = '400px', z = null;

            if (isMobile) {
                // „Çπ„Éû„Éõ: DB„ÅÆlayoutMobile.h „Åæ„Åü„ÅØ „Éá„Éï„Ç©„É´„Éà
                h = (layoutMobile && layoutMobile.h) ? layoutMobile.h : '350px';
                // „Çπ„Éû„Éõ„ÅØCSS„ÅßÂº∑Âà∂ÈÖçÁΩÆ„Åï„Çå„Çã„ÅÆ„Åß„ÄÅinline style„Å´„ÅØÈ´ò„Åï„Å†„ÅëË®≠ÂÆö„Åô„Çã
                styleStr = `height:${h}; --font-size:${fontSize};`;
            } else {
                // PC: DB„ÅÆlayoutPC „Åæ„Åü„ÅØ ÂºïÊï∞x,y
                if (layoutPC) {
                    x = layoutPC.x; y = layoutPC.y; w = layoutPC.w; h = layoutPC.h; z = layoutPC.z;
                } else {
                    w = '320px'; h = '400px'; 
                }
                if(z===null || z===undefined){ zIndexCounter++; z=zIndexCounter; }
                else if(z>zIndexCounter) zIndexCounter=z;

                styleStr = `left:${x}; top:${y}; width:${w}; height:${h}; z-index:${z}; --font-size:${fontSize};`;
            }

            const cvs=document.getElementById('canvas');
            const div=document.createElement('div');
            div.className='window'; div.id=winId;
            div.style.cssText = styleStr;

            div.innerHTML=`
                <div class="win-header" onmousedown="startDrag(event,'${winId}')">
                    <span class="win-title">Window ${idNum}</span>
                    <button class="btn-delete" onclick="removeWindow('${winId}')">√ó</button>
                </div>
                <div class="win-body" onmousedown="bringToFront('${winId}')"
                     ondragover="handleDragOver(event,this)" ondragleave="handleDragLeave(event,this)"
                     ondrop="handleDrop(event,'${winId}')">
                    
                    <div class="win-tools">
                        <button class="btn-tool" onclick="pasteToArea(${idNum})">üìã Paste</button>
                        <div style="flex-grow:1;"></div>
                        <button class="btn-tool btn-font" onclick="changeFontSize(${idNum}, -2)">A-</button>
                        <button class="btn-tool" onclick="resetFontSize(${idNum})" title="„Éá„Éï„Ç©„É´„Éà(14px)„Å´Êàª„Åô">Def</button>
                        <button class="btn-tool btn-font" onclick="changeFontSize(${idNum}, 2)">A+</button>
                    </div>

                    <textarea id="text-${idNum}" style="font-size:${fontSize};" oninput="notifyChange('${winId}')"></textarea>
                    
                    <button class="btn-format" onclick="formatContent(${idNum})">Êï¥ÂΩ¢</button>
                    <div id="media-${idNum}" class="media-layer">
                        <button class="btn-close-media" onclick="closeMedia(${idNum})">√ó</button>
                        <div id="media-content-${idNum}" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div>
                    </div>
                </div>`;
            cvs.appendChild(div);

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            div.addEventListener('mouseup', ()=> { if(currentDragWin!==div) notifyChange(winId); });
            div.querySelector('textarea').addEventListener('scroll', (e)=>{
                if(document.getElementById('syncToggle').checked) {
                    const t=e.target.scrollTop;
                    document.querySelectorAll('textarea').forEach(ta=>{ if(ta!==e.target && ta.offsetParent) ta.scrollTop=t; });
                }
            });
            
            bringToFront(winId);
            return div;
        }

        function restoreWindow(r) {
            // v4‰∫íÊèõ: layoutPC/Mobile„Åå„Å™„Åë„Çå„Å∞‰Ωú„Çã
            let lPC = r.layoutPC;
            if(!lPC) lPC = { x:r.x, y:r.y, w:r.w, h:r.h, z:r.z };
            
            const w = addWindow(0,0,r.id, lPC, r.layoutMobile, r.fontSize);
            
            if(r.text) w.querySelector('textarea').value=r.text;
            if(r.hasMedia && r.mediaBlob) {
                blobCache[r.id]={blob:r.mediaBlob, type:r.mediaType};
                showMedia(r.id, r.mediaBlob, r.mediaType);
            }
        }

        function removeWindow(id) {
            const el=document.getElementById(id);
            if(el){ el.remove(); deleteWindowFromDB(parseInt(id.split('-')[1])); }
        }

        // --- Font Size Control ---
        function changeFontSize(idNum, delta) {
            const ta = document.getElementById(`text-${idNum}`);
            const win = document.getElementById(`win-${idNum}`);
            if(!ta) return;
            
            let current = parseInt(win.style.getPropertyValue('--font-size') || "14");
            let next = current + delta;
            if(next < 10) next = 10;
            if(next > 60) next = 60;
            
            const sizeStr = next + "px";
            ta.style.fontSize = sizeStr;
            win.style.setProperty('--font-size', sizeStr);
            
            notifyChange(`win-${idNum}`);
        }

        function resetFontSize(idNum) {
            const ta = document.getElementById(`text-${idNum}`);
            const win = document.getElementById(`win-${idNum}`);
            if(!ta) return;
            
            const defaultSize = "14px";
            ta.style.fontSize = defaultSize;
            win.style.setProperty('--font-size', defaultSize);
            
            notifyChange(`win-${idNum}`);
        }

        // --- Media ---
        function showMedia(id,blob,type) {
            const c=document.getElementById(`media-content-${id}`);
            c.innerHTML='';
            const url=URL.createObjectURL(blob);
            let el;
            if(type.startsWith('image/')) { el=document.createElement('img'); el.src=url; }
            else if(type.startsWith('video/')) {
                el=document.createElement('video'); el.src=url;
                el.controls=true; el.loop=true; el.muted=true; el.playsInline=true;
            }
            if(el){ el.className='media-content'; c.appendChild(el); document.getElementById(`media-${id}`).classList.add('show'); }
        }
        function handleDragOver(e,el){ e.preventDefault(); e.stopPropagation(); el.closest('.window').classList.add('drag-over-active'); }
        function handleDragLeave(e,el){ e.preventDefault(); e.stopPropagation(); el.closest('.window').classList.remove('drag-over-active'); }
        function handleDrop(e,winId){
            e.preventDefault(); e.stopPropagation();
            document.getElementById(winId).classList.remove('drag-over-active');
            const f=e.dataTransfer.files[0];
            if(!f)return;
            const id=parseInt(winId.split('-')[1]);
            blobCache[id]={blob:f, type:f.type};
            showMedia(id,f,f.type);
            notifyChange(winId);
        }
        function closeMedia(id){
            document.getElementById(`media-${id}`).classList.remove('show');
            const c=document.getElementById(`media-content-${id}`);
            if(c.firstChild) URL.revokeObjectURL(c.firstChild.src);
            c.innerHTML='';
            delete blobCache[id];
            notifyChange('win-'+id);
        }

        // --- Drag (PC) ---
        let currentDragWin=null, dx=0, dy=0;
        function startDrag(e,id) {
            if(window.innerWidth<=768)return; // „Çπ„Éû„Éõ„Åß„ÅØ„Éâ„É©„ÉÉ„Ç∞ÁÑ°Âäπ
            if(e.target.tagName==='BUTTON')return;
            const w=document.getElementById(id);
            bringToFront(id);
            currentDragWin=w;
            dx=e.clientX-w.offsetLeft; dy=e.clientY-w.offsetTop;
            document.addEventListener('mousemove',onMouseMove);
            document.addEventListener('mouseup',onMouseUp);
        }
        function onMouseMove(e){
            if(!currentDragWin)return;
            let nx=e.clientX-dx, ny=e.clientY-dy;
            if(ny<0)ny=0;
            currentDragWin.style.left=nx+'px'; currentDragWin.style.top=ny+'px';
        }
        function onMouseUp(){
            if(currentDragWin) notifyChange(currentDragWin.id);
            currentDragWin=null;
            document.removeEventListener('mousemove',onMouseMove);
            document.removeEventListener('mouseup',onMouseUp);
        }
        function bringToFront(id){
            const w=document.getElementById(id);
            zIndexCounter++; w.style.zIndex=zIndexCounter;
            document.querySelectorAll('.window').forEach(e=>e.classList.remove('active'));
            w.classList.add('active');
            notifyChange(id);
        }

        // --- Utils ---
        async function pasteToArea(id){
            try{
                const t=await navigator.clipboard.readText();
                document.getElementById('text-'+id).value=t; notifyChange('win-'+id);
            }catch(e){alert('„Éö„Éº„Çπ„ÉàÊ®©Èôê„Å™„Åó');}
        }
        function formatContent(id){
            const ta=document.getElementById('text-'+id);
            let t=ta.value; if(!t)return;
            t=t.replace(/\r\n/g,'\n').replace(/([^\n])(„Äê)/g,'$1\n\n$2')
               .replace(/\s+(\d+\.)/g,'\n$1')
               .replace(/([^\n])(„Äå)/g,(m,p1,p2)=> /[\d\.\s]/.test(p1)?m:p1+'\n'+p2)
               .replace(/(„Äç)(\s+)(\d+\.)/g,'$1\n$3');
            ta.value=t; notifyChange('win-'+id);
        }
    </script>
</body>
</html>
