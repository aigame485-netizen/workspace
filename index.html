<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Workspace v8.2</title>
    <style>
        /* --- ÂÖ®‰ΩìË®≠ÂÆö --- */
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #1a202c;
            background-image: radial-gradient(#2d3748 1px, transparent 1px);
            background-size: 20px 20px;
            color: #e2e8f0; margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- „Éò„ÉÉ„ÉÄ„Éº --- */
        header {
            background-color: #171923; border-bottom: 1px solid #4a5568;
            padding: 0 10px; height: 50px; display: flex; align-items: center;
            gap: 10px; flex-shrink: 0; z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); overflow-x: auto; white-space: nowrap;
        }
        header::-webkit-scrollbar { display: none; } 
        h1 { font-size: 1rem; color: #a0aec0; margin-right: 5px; font-weight: normal; }

        /* --- „Éú„Éº„ÉâË°®Á§∫ --- */
        .board-indicator {
            background-color: #2d3748; padding: 4px 10px; border-radius: 4px; border: 1px solid #4a5568;
            font-size: 0.85rem; color: #e2e8f0; cursor: default; display: flex; align-items: center; gap: 5px;
            margin-right: auto; /* Âè≥ÂÅ¥„ÅÆ‰ΩôÁôΩ„ÇíÊúÄÂ§ß„Å´Âèñ„Çã */
        }
        .board-name { font-weight: bold; color: #63b3ed; }

        /* --- „Éú„Çø„É≥È°û --- */
        .control-group {
            display: flex; align-items: center; gap: 8px;
            background-color: #2d3748; padding: 4px 8px;
            border-radius: 4px; border: 1px solid #4a5568;
        }
        .btn-control {
            background-color: #2b6cb0; color: white; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 0.8rem; transition: all 0.2s; white-space: nowrap;
        }
        .btn-control:hover { background-color: #3182ce; }
        .btn-control:disabled { background-color: #4a5568; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background-color: #9b2c2c; }
        .btn-cloud { background-color: #d69e2e; color: #1a202c; font-weight: bold; }
        .btn-cloud:hover { background-color: #ecc94b; }

        .switch-label { font-size: 0.75rem; color: #cbd5e0; cursor: pointer; user-select: none; margin-left: 5px;}
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #4a5568; transition: .4s; border-radius: 16px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(14px); }

        #status-indicator { font-size: 0.75rem; color: #ecc94b; min-width: 50px; text-align: right; margin-right: 5px;}
        #status-indicator.saved { color: #48bb78; }
        #status-indicator.error { color: #f56565; }

        /* --- „Ç≠„É£„É≥„Éê„Çπ --- */
        #canvas {
            position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: auto; 
        }

        /* --- „Ç¶„Ç£„É≥„Éâ„Ç¶ --- */
        .window {
            position: absolute; background-color: #222630;
            border: 1px solid #4a5568; border-radius: 6px;
            display: flex; flex-direction: column;
            width: 320px; height: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            resize: both; overflow: hidden;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-width: 150px; min-height: 150px; box-sizing: border-box; 
        }
        .window.active { border-color: #63b3ed; box-shadow: 0 15px 35px rgba(0,0,0,0.7); }
        
        .win-header {
            padding: 6px 8px; background-color: #2d3748; border-bottom: 1px solid #4a5568;
            display: flex; align-items: center;
            cursor: move; user-select: none; flex-shrink: 0; gap: 5px;
        }
        
        .win-title-input {
            width: 140px; flex-shrink: 0;
            background: transparent; border: 1px solid transparent;
            color: #e2e8f0; font-weight: bold; font-size: 0.85rem;
            padding: 2px 4px; border-radius: 4px; 
            overflow: hidden; text-overflow: ellipsis;
        }
        .win-title-input:hover { border-color: #4a5568; background-color: #2d3748; }
        .win-title-input:focus { border-color: #63b3ed; background-color: #1a202c; outline: none; width: 180px; z-index: 10;}

        .win-drag-area { flex-grow: 1; height: 100%; cursor: move; }

        .btn-header-icon { background: none; border: none; color: #a0aec0; cursor: pointer; font-size: 1rem; padding: 0 4px; }
        .btn-delete { color: #fc8181; font-size: 1.2rem; line-height: 1; border:none; background:none; cursor:pointer;}
        
        .win-body { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .win-tools { 
            padding: 5px; background-color: #1a202c; display: flex; align-items: center; 
            gap: 4px; flex-shrink: 0; border-bottom: 1px solid #2d3748; flex-wrap: wrap;
        }
        textarea {
            flex-grow: 1; width: 100%; background-color: #222630; color: #e2e8f0;
            border: none; padding: 10px; resize: none; line-height: 1.7; outline: none; box-sizing: border-box; 
        }
        .btn-tool { cursor: pointer; border: none; color: #e2e8f0; background-color: #4a5568; border-radius: 3px; padding: 4px 8px; font-size: 0.7rem; white-space: nowrap;}
        .btn-tool:hover { background-color: #718096; }
        .btn-font { font-family: monospace; font-weight: bold; width: 24px; padding: 4px 0; text-align: center; }
        .btn-format { background-color: #553c9a; color: #e9d8fd; }
        .mobile-resize-handle {
            height: 12px; background-color: #2d3748; cursor: row-resize; flex-shrink: 0;
            display: none; justify-content: center; align-items: center;
        }
        .mobile-resize-handle::after { content: ""; width: 40px; height: 4px; background-color: #4a5568; border-radius: 2px; }
        .media-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #000;
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }
        .media-layer.show { display: flex; }
        .media-content { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-close-media {
            position: absolute; top: 10px; right: 10px; background-color: rgba(0,0,0,0.6);
            color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 4px 10px; cursor: pointer;
        }

        /* --- „É¢„Éº„ÉÄ„É´ (ÂÖ±ÈÄö) --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7);
            z-index: 20000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px;
            width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #e2e8f0; margin: 0; border-bottom:1px solid #4a5568; padding-bottom:5px; }
        .modal-body { display: flex; flex-direction: column; gap: 10px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;}
        
        .board-list {
            max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
            background: #1a202c; padding: 10px; border-radius: 4px; min-height: 50px;
        }
        .board-item {
            background: #4a5568; border: none; color: white; padding: 10px; text-align: left;
            cursor: pointer; border-radius: 3px; font-size: 0.95rem; display: flex; justify-content: space-between;
        }
        .board-item:hover { background-color: #63b3ed; }
        .board-item.current { border-left: 4px solid #48bb78; font-weight: bold; background-color: #2f855a; }
        
        .input-group { display: flex; gap: 5px; }
        .input-text {
            background: #1a202c; border: 1px solid #4a5568; color: white;
            padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box;
        }

        .mobile-only { display: none; }
        .pc-only { display: block; }

        @media (max-width: 768px) {
            h1 { display: none; }
            header { gap: 8px; padding: 0 8px; }
            .btn-control { padding: 6px 8px; font-size: 0.75rem; }
            #canvas { padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; overflow-y: auto; }
            .window { position: relative !important; left: auto !important; top: auto !important; resize: none !important; margin-bottom: 0; z-index: 1 !important; flex-shrink: 0; }
            .win-header { cursor: default; }
            .mobile-resize-handle { display: flex; } 
            .mobile-only { display: inline-block; }
            .pc-only { display: none; }
        }

        /* --- „Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ„É™„Çπ„ÉàÁî®„ÅÆËøΩÂä†CSS --- */
        .file-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #4a5568; padding: 10px; border-radius: 4px; margin-bottom: 6px;
            transition: background 0.2s;
        }
        .file-row:hover { background-color: #2d3748; border: 1px solid #63b3ed; }
        .file-name { 
            font-weight: bold; color: #e2e8f0; flex-grow: 1; padding-right: 10px; 
            cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .file-actions { display: flex; gap: 8px; }
        .btn-mini {
            padding: 4px 10px; font-size: 0.75rem; border-radius: 3px; border: none; cursor: pointer; color: white;
        }
        .btn-load { background-color: #38a169; }
        .btn-load:hover { background-color: #48bb78; }
        .btn-trash { background-color: #e53e3e; }
        .btn-trash:hover { background-color: #fc8181; }
    </style>
</head>
<body>

    <header>
        <h1>Canvas v8.2</h1>
        
        <!-- ÂêçÂâçË°®Á§∫ („ÇØ„É™„ÉÉ„ÇØ‰∏çÂèØ) -->
        <div class="board-indicator">
            üìÅ <span id="current-board-name" class="board-name">default</span>
        </div>

        <!-- Âè≥ÂØÑ„Åõ„Ç∞„É´„Éº„Éó -->
        <span id="status-indicator">Ready</span>

        <!-- „Éú„Çø„É≥„Çí‰∏ÄÊú¨Âåñ -->
        <button class="btn-control btn-cloud" onclick="openCloudModal()">‚òÅÔ∏è „ÇØ„É©„Ç¶„ÉâÊé•Á∂ö</button>

        <div class="control-group">
            <label class="switch">
                <input type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()">
                <span class="slider"></span>
            </label>
            <label for="autoSaveToggle" class="switch-label">Auto</label>
        </div>

        <button class="btn-control" id="btn-manual-save" onclick="manualSaveAll()">üíæ ‰øùÂ≠ò</button>
        <button class="btn-control" onclick="createNewWindow()">Ôºã</button>
        <button class="btn-control btn-danger" onclick="clearAllData()">üóëÔ∏è</button>
        
        <div style="width:10px;"></div>
        <div class="control-group">
             <label class="switch">
                <input type="checkbox" id="syncToggle">
                <span class="slider"></span>
            </label>
            <label for="syncToggle" class="switch-label">ÈÄ£Âãï</label>
        </div>
    </header>

    <div id="canvas"></div>

    <!-- Áµ±Âêà„ÇØ„É©„Ç¶„ÉâÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="cloudModal" class="modal-overlay" onclick="if(event.target===this) closeModal('cloudModal')">
        <div class="modal-box" style="max-width: 450px;">
            <h3 class="modal-title">‚òÅÔ∏è „ÇØ„É©„Ç¶„ÉâÈÄ£Êê∫</h3>
            
            <div class="modal-body">
                <!-- ‰∏äÊÆµÔºö‰øùÂ≠ò„Ç®„É™„Ç¢ -->
                <div style="background:#2d3748; padding-bottom:15px; border-bottom:2px dashed #4a5568; margin-bottom:10px;">
                    <p style="margin:0 0 10px 0; font-size:0.9rem; color:#cbd5e0;">
                        ÁèæÂú®„ÅÆ„Éú„Éº„Éâ: <strong id="cloud-current-name" style="color:#63b3ed; font-size:1.1rem;">default</strong>
                    </p>
                    
                    <!-- ‰∏äÊõ∏„Åç‰øùÂ≠ò„Éú„Çø„É≥ -->
                    <button class="btn-control btn-cloud" style="width:100%; padding:10px; margin-bottom:10px; font-size:1rem;" onclick="processUpload(currentBoardName)">
                        ‚¨ÜÔ∏è „Åì„ÅÆÂêçÂâç„Åß‰∏äÊõ∏„Åç‰øùÂ≠ò
                    </button>
                    
                    <!-- Âà•Âêç‰øùÂ≠ò -->
                    <div class="input-group">
                        <input type="text" id="newBoardInput" class="input-text" placeholder="Êñ∞„Åó„ÅÑÂêçÂâç„Åß‰øùÂ≠ò...">
                        <button class="btn-control" onclick="processUploadNew()">Êñ∞Ë¶è‰øùÂ≠ò</button>
                    </div>
                </div>

                <!-- ‰∏ãÊÆµÔºö„Éï„Ç°„Ç§„É´„É™„Çπ„Éà„Ç®„É™„Ç¢ -->
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span style="font-size:0.85rem; color:#a0aec0;">„ÇØ„É©„Ç¶„Éâ‰∏ä„ÅÆ„Éï„Ç°„Ç§„É´‰∏ÄË¶ß:</span>
                        <button class="btn-mini" style="background:none; border:1px solid #4a5568; color:#cbd5e0;" onclick="refreshBoardList()">‚Üª Êõ¥Êñ∞</button>
                    </div>
                    <div id="cloudList" class="board-list" style="height:250px;">
                        <div style="text-align:center; color:#718096; padding:20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-control" onclick="closeModal('cloudModal')">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyCsdPclvOpyEyxB4fEklillB729ge_b9-q9afAZPartKazdS9-6u8xkfDercVRaLl2/exec"; 

        const DB_NAME = 'CreativeWorkspaceDB_v7'; 
        const DB_VERSION = 3;
        const STORE_WINDOWS = 'windows';
        const STORE_SETTINGS = 'settings';

        let db = null;
        let zIndexCounter = 100;
        let isAutoSaveEnabled = false;
        let isSaving = false;
        let saveTimers = {};
        let blobCache = {};
        
        let currentBoardName = "default";

        window.onload = async function() {
            await initDB();
            const savedBoard = await getSetting('current_board_name');
            if (savedBoard) currentBoardName = savedBoard;
            const savedAuto = await getSetting('auto_save_enabled');
            if (savedAuto === true) {
                isAutoSaveEnabled = true;
                document.getElementById('autoSaveToggle').checked = true;
                document.getElementById('btn-manual-save').disabled = true;
            }
            updateBoardDisplay();
            loadFromDB();
        };

        async function getSetting(key) {
            try {
                const tx = db.transaction([STORE_SETTINGS], 'readonly');
                const req = tx.objectStore(STORE_SETTINGS).get(key);
                const res = await new Promise(r => req.onsuccess = () => r(req.result));
                return res ? res.value : null;
            } catch(e) { return null; }
        }
        async function setSetting(key, val) {
            const tx = db.transaction([STORE_SETTINGS], 'readwrite');
            tx.objectStore(STORE_SETTINGS).put({ key: key, value: val });
        }
        async function getAuthPassword() {
            let pass = await getSetting('auth_password');
            if(!pass) {
                pass = prompt("ÂêàË®ÄËëâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                if(pass) await setSetting('auth_password', pass);
            }
            return pass;
        }
        async function clearAuthPassword() {
            const tx = db.transaction([STORE_SETTINGS], 'readwrite');
            tx.objectStore(STORE_SETTINGS).delete('auth_password');
        }

        function updateBoardDisplay() {
            document.getElementById('current-board-name').textContent = currentBoardName;
            document.getElementById('cloud-current-name').textContent = currentBoardName;
        }

        // --- „ÇØ„É©„Ç¶„ÉâÈÄ£Êê∫Èñ¢ÈÄ£ ---

        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        // 1. „É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºà‰øùÂ≠ò„Å®‰∏ÄË¶ß„ÇíÂêåÊôÇ„Å´Ë°®Á§∫Ôºâ
        async function openCloudModal() {
            await manualSaveAll(); // „É≠„Éº„Ç´„É´‰øùÂ≠ò
            document.getElementById('cloudModal').classList.add('show');
            
            // ÁèæÂú®„ÅÆ„Éú„Éº„ÉâÂêç„ÇíË°®Á§∫
            updateBoardDisplay();
            document.getElementById('newBoardInput').value = "";
            
            // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            refreshBoardList();
        }

        // 2. „É™„Çπ„ÉàÂèñÂæó
        async function refreshBoardList() {
            const listEl = document.getElementById('cloudList');
            listEl.innerHTML = '<div style="text-align:center; color:#718096; padding:20px;">‰∏ÄË¶ß„ÇíÂèñÂæó‰∏≠...</div>';
            
            const pass = await getAuthPassword();
            if(!pass) { listEl.innerHTML='<div style="text-align:center;">Ë™çË®º„ÅåÂøÖË¶Å„Åß„Åô</div>'; return; }

            try {
                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&action=list`;
                const res = await fetch(url, { method: 'POST' });
                
                const text = await res.text();
                let json;
                try { json = JSON.parse(text); } catch(e) { throw new Error("„Çµ„Éº„Éê„ÉºÂøúÁ≠î„Ç®„É©„Éº"); }

                if(json.status === 'success') {
                    listEl.innerHTML = '';
                    if(json.boards.length === 0) {
                        listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#cbd5e0;">„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    } else {
                        json.boards.forEach(name => {
                            const div = document.createElement('div');
                            div.className = 'file-row';
                            const isCurrent = (name === currentBoardName);
                            const nameDisplay = isCurrent ? `üëâ ${name}` : `üìÑ ${name}`;
                            const bgStyle = isCurrent ? 'border-left: 3px solid #48bb78; background-color:#2f855a;' : '';
                            
                            div.style.cssText = bgStyle;
                            div.innerHTML = `
                                <div class="file-name" onclick="processDownload('${name}')">${nameDisplay}</div>
                                <div class="file-actions">
                                    <button class="btn-mini btn-load" onclick="processDownload('${name}')">Ë™≠Ëæº</button>
                                    <button class="btn-mini btn-trash" onclick="deleteBoard('${name}')">ÂâäÈô§</button>
                                </div>
                            `;
                            listEl.appendChild(div);
                        });
                    }
                } else {
                    if(json.message && json.message.includes("ÂêàË®ÄËëâ")) await clearAuthPassword();
                    throw new Error(json.message);
                }
            } catch(e) { 
                listEl.innerHTML = `<div style="color:#f56565; padding:10px; text-align:center;">„Ç®„É©„Éº: ${e.message}</div>`; 
            }
        }

        // 3. Êñ∞Ë¶è‰øùÂ≠òÂá¶ÁêÜ
        async function processUploadNew() {
            const name = document.getElementById('newBoardInput').value.trim();
            if(!name) return alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            processUpload(name);
        }

        // 4. „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜÔºàÂÆå‰∫ÜÂæå„Å´„É™„Çπ„Éà„ÇíÊõ¥Êñ∞Ôºâ
        async function processUpload(boardName) {
            const pass = await getAuthPassword();
            if (!pass) return;
            if(!confirm(`„Éú„Éº„Éâ„Äå${boardName}„Äç„Å®„Åó„Å¶„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü`)) return;
            
            updateStatus("ÈÄÅ‰ø°‰∏≠...", false);
            
            try {
                const tx = db.transaction([STORE_WINDOWS], 'readonly');
                const req = tx.objectStore(STORE_WINDOWS).getAll();
                let records = await new Promise(r => req.onsuccess = () => r(req.result));
                records.sort((a,b) => (a.order || 0) - (b.order || 0));

                const exportData = [];
                for(let r of records) {
                    let b64 = null;
                    if(r.hasMedia && r.mediaBlob) b64 = await blobToBase64(r.mediaBlob);
                    exportData.push({
                        id: r.id, title: r.title, order: r.order,
                        layoutPC: r.layoutPC, layoutMobile: r.layoutMobile, fontSize: r.fontSize,
                        text: r.text, hasMedia: r.hasMedia, mediaType: r.mediaType, mediaBase64: b64
                    });
                }

                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&boardName=${encodeURIComponent(boardName)}`;
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(exportData) });
                const json = await res.json();
                
                if(json.status === 'success') { 
                    currentBoardName = boardName;
                    await setSetting('current_board_name', currentBoardName);
                    
                    updateBoardDisplay(); 
                    document.getElementById('newBoardInput').value = "";
                    
                    updateStatus("‰øùÂ≠òÂÆå‰∫Ü", true); 
                    alert(`[${currentBoardName}] ‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
                    
                    refreshBoardList(); // „É™„Çπ„ÉàÊõ¥Êñ∞
                } else { 
                    throw new Error(json.message); 
                }
            } catch(e) { console.error(e); updateStatus("UPÂ§±Êïó", false, true); alert(e.message); }
        }

        // 5. ÂâäÈô§Âá¶ÁêÜ
        async function deleteBoard(boardName) {
            if(!confirm(`Êú¨ÂΩì„Å´„ÇØ„É©„Ç¶„Éâ‰∏ä„ÅÆ„Äå${boardName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºàÂæ©ÂÖÉ„Åß„Åç„Åæ„Åõ„ÇìÔºâ`)) return;

            updateStatus("ÂâäÈô§‰∏≠...", false);
            const pass = await getAuthPassword();
            
            try {
                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&action=delete&boardName=${encodeURIComponent(boardName)}`;
                const res = await fetch(url, { method: 'POST' });
                const json = await res.json();

                if(json.status === 'success') {
                    updateStatus("ÂâäÈô§ÂÆå‰∫Ü", true);
                    refreshBoardList();
                } else {
                    throw new Error(json.message);
                }
            } catch(e) {
                alert("ÂâäÈô§Â§±Êïó: " + e.message);
                updateStatus("ÂâäÈô§Â§±Êïó", false, true);
            }
        }

        // 6. „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂá¶ÁêÜ
        async function processDownload(boardName) {
            if(!confirm(`„Éú„Éº„Éâ„Äå${boardName}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü\n(ÁèæÂú®„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô)`)) return;
            
            updateStatus("Âèó‰ø°‰∏≠...", false);
            const pass = await getAuthPassword(); 
            try {
                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&action=download&boardName=${encodeURIComponent(boardName)}`;
                const res = await fetch(url, { method: 'POST', body: "" });
                const text = await res.text();
                let importData;
                try { importData = JSON.parse(text); } catch(e) { throw new Error("JSON Parse Error"); }
                if (importData.status === 'error') throw new Error(importData.message);

                await clearAllData(true); 

                for(let i=0; i<importData.length; i++) {
                    let r = importData[i];
                    let blob = null;
                    if(r.hasMedia && r.mediaBase64) blob = await base64ToBlob(r.mediaBase64);
                    if(blob) blobCache[r.id] = { blob: blob, type: r.mediaType };
                    let lPC = r.layoutPC || { x: r.x||'50px', y: r.y||'50px', w: r.w||'320px', h: r.h||'400px', z: r.z||100 };
                    let lMob = r.layoutMobile || { h: '350px', w: '100%' };
                    let fSize = r.fontSize || '14px';
                    let title = r.title || `Window ${r.id}`;
                    let order = (r.order !== undefined) ? r.order : i;
                    const record = {
                        id: r.id, title: title, order: order,
                        layoutPC: lPC, layoutMobile: lMob, fontSize: fSize,
                        text: r.text, hasMedia: r.hasMedia, mediaBlob: blob, mediaType: r.mediaType
                    };
                    const tx = db.transaction([STORE_WINDOWS], 'readwrite');
                    tx.objectStore(STORE_WINDOWS).put(record);
                }
                currentBoardName = boardName;
                await setSetting('current_board_name', currentBoardName);
                
                updateBoardDisplay();
                loadFromDB();
                
                closeModal('cloudModal'); 
                updateStatus("Ë™≠ËæºÂÆå‰∫Ü", true);
                alert(`Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${boardName}`);
            } catch(e) { console.error(e); updateStatus("DOWNÂ§±Êïó", false, true); alert(e.message); }
        }

        // --- ÂÖ±ÈÄö„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---

        function blobToBase64(blob) { return new Promise((r,j)=>{const z=new FileReader();z.onloadend=()=>r(z.result);z.onerror=j;z.readAsDataURL(blob);}); }
        async function base64ToBlob(b64) { const r=await fetch(b64); return await r.blob(); }

        function initDB() {
            return new Promise((resolve, reject) => {
                const r = indexedDB.open(DB_NAME, DB_VERSION);
                r.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains(STORE_WINDOWS)) d.createObjectStore(STORE_WINDOWS, { keyPath: 'id' });
                    if (!d.objectStoreNames.contains(STORE_SETTINGS)) d.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                };
                r.onsuccess = (e) => { db = e.target.result; resolve(db); };
                r.onerror = (e) => reject(e);
            });
        }
        
        async function saveWindowToDB(winId) {
            if (!db) return;
            const el = document.getElementById(winId); if (!el) return;
            const idNum = parseInt(winId.split('-')[1]);
            const isMobile = window.innerWidth <= 768;
            const tx = db.transaction([STORE_WINDOWS], 'readonly');
            const old = await new Promise(r => { const req = tx.objectStore(STORE_WINDOWS).get(idNum); req.onsuccess = () => r(req.result); });
            const ta = el.querySelector('textarea');
            const titleInput = el.querySelector('.win-title-input');
            const mediaLayer = document.getElementById(`media-${idNum}`);
            const isMediaShow = mediaLayer.classList.contains('show');
            let blob = null, type = null;
            if (isMediaShow && blobCache[idNum]) { blob = blobCache[idNum].blob; type = blobCache[idNum].type; }
            const allWins = Array.from(document.getElementById('canvas').children);
            const myOrder = allWins.indexOf(el);
            let layoutPC = (old && old.layoutPC) ? old.layoutPC : { x:'50px', y:'50px', w:'320px', h:'400px', z:100 };
            let layoutMobile = (old && old.layoutMobile) ? old.layoutMobile : { h:'350px', w:'100%' };
            let fontSize = el.style.getPropertyValue('--font-size') || '14px';
            if (isMobile) { layoutMobile.h = el.style.height; layoutMobile.w = el.style.width; } 
            else { layoutPC.x = el.style.left; layoutPC.y = el.style.top; layoutPC.w = el.style.width; layoutPC.h = el.style.height; layoutPC.z = parseInt(el.style.zIndex || 100); }
            const data = {
                id: idNum, title: titleInput.value, order: myOrder,
                layoutPC: layoutPC, layoutMobile: layoutMobile, fontSize: fontSize,
                text: ta.value, hasMedia: isMediaShow, mediaBlob: blob, mediaType: type
            };
            return new Promise(res => {
                const tx2 = db.transaction([STORE_WINDOWS], 'readwrite');
                tx2.objectStore(STORE_WINDOWS).put(data);
                tx2.oncomplete = () => { updateStatus('‰øùÂ≠òÊ∏à', true); res(); };
            });
        }
        async function deleteWindowFromDB(id) {
            if(!db) return;
            const tx = db.transaction([STORE_WINDOWS], 'readwrite');
            tx.objectStore(STORE_WINDOWS).delete(id);
            delete blobCache[id];
        }
        async function loadFromDB() {
            if(!db) return;
            document.getElementById('canvas').innerHTML = '';
            const tx = db.transaction([STORE_WINDOWS], 'readonly');
            const req = tx.objectStore(STORE_WINDOWS).getAll();
            req.onsuccess = (e) => {
                let r = e.target.result;
                r.sort((a,b) => { if (a.order !== undefined && b.order !== undefined) return a.order - b.order; return a.id - b.id; });
                if(r.length===0){ addWindow(50,50,1); addWindow(400,50,2); }
                else r.forEach(rec => restoreWindow(rec));
                updateStatus('Ready', true);
            };
        }
        async function clearAllData(skip=false) {
            if(!skip && !confirm("ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
            document.getElementById('canvas').innerHTML=''; blobCache={};
            const tx = db.transaction([STORE_WINDOWS], 'readwrite');
            tx.objectStore(STORE_WINDOWS).clear();
            if(!skip) updateStatus('ÂâäÈô§ÂÆå‰∫Ü', true);
        }
        async function toggleAutoSave() { 
            isAutoSaveEnabled = document.getElementById('autoSaveToggle').checked; 
            document.getElementById('btn-manual-save').disabled = isAutoSaveEnabled;
            await setSetting('auto_save_enabled', isAutoSaveEnabled);
        }
        function notifyChange(winId) {
            if (!isAutoSaveEnabled) return;
            if (saveTimers[winId]) clearTimeout(saveTimers[winId]);
            updateStatus('Â§âÊõ¥...', false);
            saveTimers[winId] = setTimeout(async () => {
                if(isSaving) { notifyChange(winId); return; }
                isSaving=true;
                try { await saveWindowToDB(winId); } finally { isSaving=false; delete saveTimers[winId]; }
            }, 1000);
        }
        async function manualSaveAll() {
            if(isSaving) return;
            isSaving=true; document.getElementById('btn-manual-save').disabled=true;
            updateStatus('‰øùÂ≠ò‰∏≠...', false);
            const wins=document.querySelectorAll('.window');
            for(const w of wins) await saveWindowToDB(w.id);
            isSaving=false; updateStatus('‰øùÂ≠òÂÆå‰∫Ü', true);
            if(!isAutoSaveEnabled) document.getElementById('btn-manual-save').disabled=false;
        }
        function updateStatus(m,s,e=false) {
            const el=document.getElementById('status-indicator'); el.textContent=m; el.className='';
            if(s) el.classList.add('saved'); if(e) el.classList.add('error');
        }
        function createNewWindow() {
            let max=0; document.querySelectorAll('.window').forEach(w=>{ const id=parseInt(w.id.split('-')[1]); if(id>max) max=id; });
            addWindow(50,50,max+1);
        }
        function addWindow(x,y,idNum, layoutPC=null, layoutMobile=null, fontSize='14px', title=null) {
            const winId='win-'+idNum;
            const isMobile = window.innerWidth <= 768;
            const initialTitle = title || `Window ${idNum}`;
            let styleStr = "";
            let w = '320px', h = '400px', z = null;
            if (isMobile) {
                h = (layoutMobile && layoutMobile.h) ? layoutMobile.h : '350px';
                let wMob = (layoutMobile && layoutMobile.w) ? layoutMobile.w : '100%';
                styleStr = `height:${h}; width:${wMob}; --font-size:${fontSize};`;
            } else {
                if (layoutPC) { x = layoutPC.x; y = layoutPC.y; w = layoutPC.w; h = layoutPC.h; z = layoutPC.z; }
                if(z===null || z===undefined){ zIndexCounter++; z=zIndexCounter; }
                else if(z>zIndexCounter) zIndexCounter=z;
                styleStr = `left:${x}; top:${y}; width:${w}; height:${h}; z-index:${z}; --font-size:${fontSize};`;
            }
            const cvs=document.getElementById('canvas');
            const div=document.createElement('div');
            div.className='window'; div.id=winId; div.style.cssText = styleStr;
            const widthBtnLabel = (div.style.width === '100%' || !div.style.width) ? '1/2' : 'Full';
            div.innerHTML=`
                <div class="win-header" onmousedown="startDrag(event,'${winId}')">
                    <button class="btn-header-icon mobile-only" onclick="moveWindow('${winId}', -1)">‚Üë</button>
                    <button class="btn-header-icon mobile-only" onclick="moveWindow('${winId}', 1)">‚Üì</button>
                    <input type="text" class="win-title-input" value="${initialTitle}" onchange="notifyChange('${winId}')" onmousedown="event.stopPropagation()">
                    <div class="win-drag-area"></div>
                    <button class="btn-delete" onclick="removeWindow('${winId}')">√ó</button>
                </div>
                <div class="win-body" onmousedown="bringToFront('${winId}')" ondragover="handleDragOver(event,this)" ondragleave="handleDragLeave(event,this)" ondrop="handleDrop(event,'${winId}')">
                    <div class="win-tools">
                        <button class="btn-tool" onclick="pasteToArea(${idNum})">Paste</button>
                        <button class="btn-tool btn-format" onclick="formatContent(${idNum})">Êï¥ÂΩ¢</button>
                        <div style="flex-grow:1;"></div>
                        <button class="btn-tool btn-font" onclick="changeFontSize(${idNum}, -2)">A-</button>
                        <button class="btn-tool" onclick="resetFontSize(${idNum})" title="Reset">Def</button>
                        <button class="btn-tool btn-font" onclick="changeFontSize(${idNum}, 2)">A+</button>
                        <button class="btn-tool mobile-only" id="btn-width-${idNum}" onclick="toggleMobileWidth(${idNum})">${widthBtnLabel}</button>
                    </div>
                    <textarea id="text-${idNum}" style="font-size:${fontSize};" oninput="notifyChange('${winId}')"></textarea>
                    <div id="media-${idNum}" class="media-layer">
                        <button class="btn-close-media" onclick="closeMedia(${idNum})">√ó</button>
                        <div id="media-content-${idNum}" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div>
                    </div>
                    <div class="mobile-resize-handle" onmousedown="event.stopPropagation()" ontouchstart="startMobileResize(event, '${winId}')"></div>
                </div>`;
            cvs.appendChild(div);
            div.addEventListener('mouseup', ()=> { if(currentDragWin!==div) notifyChange(winId); });
            div.querySelector('textarea').addEventListener('scroll', (e)=>{ if(document.getElementById('syncToggle').checked) { const t=e.target.scrollTop; document.querySelectorAll('textarea').forEach(ta=>{ if(ta!==e.target && ta.offsetParent) ta.scrollTop=t; }); } });
            bringToFront(winId);
            return div;
        }
        function restoreWindow(r) {
            let lPC = r.layoutPC || { x:r.x, y:r.y, w:r.w, h:r.h, z:r.z };
            const w = addWindow(0,0,r.id, lPC, r.layoutMobile, r.fontSize, r.title);
            if(r.text) w.querySelector('textarea').value=r.text;
            if(r.hasMedia && r.mediaBlob) { blobCache[r.id]={blob:r.mediaBlob, type:r.mediaType}; showMedia(r.id, r.mediaBlob, r.mediaType); }
        }
        function removeWindow(id) { if(confirm("„Åì„ÅÆ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){ const el=document.getElementById(id); if(el){ el.remove(); deleteWindowFromDB(parseInt(id.split('-')[1])); } } }
        function moveWindow(winId, dir) { const el = document.getElementById(winId); const parent = el.parentNode; if (dir === -1) { if (el.previousElementSibling) { parent.insertBefore(el, el.previousElementSibling); manualSaveAll(); } } else { if (el.nextElementSibling) { parent.insertBefore(el.nextElementSibling, el); manualSaveAll(); } } }
        function toggleMobileWidth(idNum) { const win = document.getElementById(`win-${idNum}`); const btn = document.getElementById(`btn-width-${idNum}`); const currentW = win.style.width; if (currentW === '100%' || !currentW) { win.style.width = 'calc(50% - 5px)'; btn.textContent = 'Full'; } else { win.style.width = '100%'; btn.textContent = '1/2'; } notifyChange(`win-${idNum}`); }
        let resizingWin = null; let startTouchY = 0; let startHeight = 0;
        function startMobileResize(e, winId) { e.preventDefault(); resizingWin = document.getElementById(winId); const touch = e.touches[0]; startTouchY = touch.clientY; startHeight = parseInt(window.getComputedStyle(resizingWin).height, 10); document.addEventListener('touchmove', onMobileResizeMove, {passive: false}); document.addEventListener('touchend', onMobileResizeEnd); }
        function onMobileResizeMove(e) { if (!resizingWin) return; e.preventDefault(); const touch = e.touches[0]; const newH = startHeight + (touch.clientY - startTouchY); if (newH > 100) resizingWin.style.height = newH + 'px'; }
        function onMobileResizeEnd(e) { if (resizingWin) notifyChange(resizingWin.id); resizingWin = null; document.removeEventListener('touchmove', onMobileResizeMove); document.removeEventListener('touchend', onMobileResizeEnd); }
        function changeFontSize(idNum, delta) { const ta = document.getElementById(`text-${idNum}`); const win = document.getElementById(`win-${idNum}`); if(!ta) return; let current = parseInt(win.style.getPropertyValue('--font-size') || "14"); let next = current + delta; if(next < 10) next = 10; if(next > 60) next = 60; const sizeStr = next + "px"; ta.style.fontSize = sizeStr; win.style.setProperty('--font-size', sizeStr); notifyChange(`win-${idNum}`); }
        function resetFontSize(idNum) { const ta = document.getElementById(`text-${idNum}`); const win = document.getElementById(`win-${idNum}`); if(!ta) return; ta.style.fontSize = "14px"; win.style.setProperty('--font-size', "14px"); notifyChange(`win-${idNum}`); }
        let currentDragWin=null, dx=0, dy=0;
        function startDrag(e,id) { if(e.target.tagName==='INPUT' || e.target.tagName==='BUTTON') return; if(window.innerWidth<=768)return; const w=document.getElementById(id); bringToFront(id); currentDragWin=w; dx=e.clientX-w.offsetLeft; dy=e.clientY-w.offsetTop; document.addEventListener('mousemove',onMouseMove); document.addEventListener('mouseup',onMouseUp); }
        function onMouseMove(e){ if(!currentDragWin)return; let nx=e.clientX-dx, ny=e.clientY-dy; if(ny<0)ny=0; currentDragWin.style.left=nx+'px'; currentDragWin.style.top=ny+'px'; }
        function onMouseUp(){ if(currentDragWin) notifyChange(currentDragWin.id); currentDragWin=null; document.removeEventListener('mousemove',onMouseMove); document.removeEventListener('mouseup',onMouseUp); }
        function bringToFront(id){ const w=document.getElementById(id); zIndexCounter++; w.style.zIndex=zIndexCounter; document.querySelectorAll('.window').forEach(e=>e.classList.remove('active')); w.classList.add('active'); notifyChange(id); }
        async function pasteToArea(id){ try{ const t=await navigator.clipboard.readText(); const ta=document.getElementById('text-'+id); const start = ta.selectionStart; const end = ta.selectionEnd; const val = ta.value; ta.value = val.substring(0, start) + t + val.substring(end); notifyChange('win-'+id); }catch(e){alert('„Éö„Éº„Çπ„ÉàÊ®©Èôê„Å™„Åó');} }
        function formatContent(id){ const ta=document.getElementById('text-'+id); let t=ta.value; if(!t)return; t=t.replace(/\r\n/g,'\n').replace(/([^\n])(„Äê)/g,'$1\n\n$2').replace(/\s+(\d+\.)/g,'\n$1').replace(/([^\n])(„Äå)/g,(m,p1,p2)=> /[\d\.\s]/.test(p1)?m:p1+'\n'+p2).replace(/(„Äç)(\s+)(\d+\.)/g,'$1\n$3'); ta.value=t; notifyChange('win-'+id); }
        function showMedia(id,blob,type) { const c=document.getElementById(`media-content-${id}`); c.innerHTML=''; const url=URL.createObjectURL(blob); let el; if(type.startsWith('image/')) { el=document.createElement('img'); el.src=url; } else if(type.startsWith('video/')) { el=document.createElement('video'); el.src=url; el.controls=true; el.loop=true; el.muted=true; el.playsInline=true; } if(el){ el.className='media-content'; c.appendChild(el); document.getElementById(`media-${id}`).classList.add('show'); } }
        function handleDragOver(e,el){ e.preventDefault(); e.stopPropagation(); el.closest('.window').classList.add('drag-over-active'); }
        function handleDragLeave(e,el){ e.preventDefault(); e.stopPropagation(); el.closest('.window').classList.remove('drag-over-active'); }
        function handleDrop(e,winId){ e.preventDefault(); e.stopPropagation(); document.getElementById(winId).classList.remove('drag-over-active'); const f=e.dataTransfer.files[0]; if(!f)return; const id=parseInt(winId.split('-')[1]); blobCache[id]={blob:f, type:f.type}; showMedia(id,f,f.type); notifyChange(winId); }
        function closeMedia(id){ document.getElementById(`media-${id}`).classList.remove('show'); const c=document.getElementById(`media-content-${id}`); if(c.firstChild) URL.revokeObjectURL(c.firstChild.src); c.innerHTML=''; delete blobCache[id]; notifyChange('win-'+id); }
    </script>
</body>
</html>
