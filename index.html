<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Workspace v9.0</title>
    <style>
        /* --- å…¨ä½“è¨­å®š --- */

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #1a202c;
            background-image: radial-gradient(#2d3748 1px, transparent 1px);
            background-size: 20px 20px;
            color: #e2e8f0; margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header {
            background-color: #171923; border-bottom: 1px solid #4a5568;
            padding: 0 10px; height: 50px; display: flex; align-items: center;
            gap: 10px; flex-shrink: 0; z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); overflow-x: auto; white-space: nowrap;
        }
        header::-webkit-scrollbar { display: none; } 
        h1 { font-size: 1rem; color: #a0aec0; margin-right: 5px; font-weight: normal; }

        /* --- ãƒœãƒ¼ãƒ‰è¡¨ç¤º --- */
        .board-indicator {
            background-color: #2d3748; padding: 4px 10px; border-radius: 4px; border: 1px solid #4a5568;
            font-size: 0.85rem; color: #e2e8f0; cursor: default; display: flex; align-items: center; gap: 5px;
            margin-right: auto;
        }
        .board-name { font-weight: bold; color: #63b3ed; }

        /* --- ãƒœã‚¿ãƒ³é¡ --- */
        .control-group {
            display: flex; align-items: center; gap: 8px;
            background-color: #2d3748; padding: 4px 8px;
            border-radius: 4px; border: 1px solid #4a5568;
        }
        .btn-control {
            background-color: #2b6cb0; color: white; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 0.8rem; transition: all 0.2s; white-space: nowrap;
        }
        .btn-control:hover { background-color: #3182ce; }
        .btn-control:disabled { background-color: #4a5568; cursor: not-allowed; opacity: 0.7; }
        .btn-danger { background-color: #9b2c2c; }
        .btn-cloud { background-color: #d69e2e; color: #1a202c; font-weight: bold; }
        .btn-cloud:hover { background-color: #ecc94b; }
        .btn-ui-toggle { background-color: #718096; font-size: 1.1rem; padding: 2px 10px; }

        .switch-label { font-size: 0.75rem; color: #cbd5e0; cursor: pointer; user-select: none; margin-left: 5px;}
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #4a5568; transition: .4s; border-radius: 16px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #48bb78; }
        input:checked + .slider:before { transform: translateX(14px); }

        #status-indicator { font-size: 0.75rem; color: #ecc94b; min-width: 50px; text-align: right; margin-right: 5px;}
        #status-indicator.saved { color: #48bb78; }
        #status-indicator.error { color: #f56565; }

        /* --- ã‚­ãƒ£ãƒ³ãƒã‚¹ --- */
        #canvas {
            position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: auto; 
            transition: padding-bottom 0.3s; /* ãƒ‰ãƒƒã‚­ãƒ³ã‚°æ™‚ã®ä½™ç™½èª¿æ•´ç”¨ */
            padding-bottom: 200px;
        }

        /* --- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ --- */

        /* ãƒ†ã‚­ã‚¹ãƒˆæ“ä½œç³»ãƒœã‚¿ãƒ³ã‚’ã¾ã¨ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ— */
        .tools-text-group {
            display: flex; gap: 4px; align-items: center;
        }

        /* ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆç”»åƒãƒ»å‹•ç”»è¡¨ç¤ºä¸­ï¼‰ã®æ™‚ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã‚’éš ã™ */
        .window.media-mode .tools-text-group {
            display: none;
        }

        /* ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒ¡ãƒ‡ã‚£ã‚¢å‰Šé™¤ãƒœã‚¿ãƒ³ãªã©ã‚’å³å´ã«å¯„ã›ã‚‹ãŸã‚ã®èª¿æ•´ */
        .window.media-mode .win-tools {
            justify-content: flex-end;
        }
        .window {
            position: absolute; background-color: #222630;
            border: 1px solid #4a5568; border-radius: 6px;
            display: flex; flex-direction: column;
            width: 320px; height: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            resize: both; overflow: hidden;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-width: 150px; min-height: 150px; box-sizing: border-box; 
        }
        .window.active { border-color: #63b3ed; box-shadow: 0 15px 35px rgba(0,0,0,0.7); }
        
        /* ãƒ‰ãƒƒã‚­ãƒ³ã‚°ï¼ˆå›ºå®šï¼‰çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .window.docked-bottom {
            position: fixed !important; bottom: 0 !important; left: 0 !important; right: 0 !important; top: auto !important;
            width: 100% !important; 
            z-index: 20000 !important;
            border-radius: 0 !important; border-top: none; border-left: none; border-right: none; border-bottom: none;
            resize: none !important; margin: 0 !important;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3); /* ä¸Šå‘ãã®å½±ã‚’è¿½åŠ  */
        }
        /* --- ãƒ‰ãƒƒã‚­ãƒ³ã‚°ç”¨ãƒãƒ³ãƒ‰ãƒ«ï¼ˆä¸è¦ã«ãªã£ãŸã®ã§éè¡¨ç¤ºï¼‰ --- */
        .dock-resize-handle {
            display: none !important;
        }
        .window.docked-bottom .dock-resize-handle {
            display: flex; /* ãƒ‰ãƒƒã‚­ãƒ³ã‚°æ™‚ã®ã¿è¡¨ç¤º */
        }
        .dock-resize-handle::after { content: ""; width: 50px; height: 4px; background-color: #718096; border-radius: 2px; }

        .win-header {
            padding: 2px 8px; /* ä¸Šä¸‹ã®ä½™ç™½ã‚’å‰Šæ¸› (6px -> 2px) */
            background-color: #2d3748; border-bottom: 1px solid #4a5568;
            display: flex; align-items: center;
            cursor: move; user-select: none; flex-shrink: 0; gap: 5px; 
            height: 28px; /* é«˜ã•ã‚’å‰Šæ¸› (36px -> 28px) */
            box-sizing: border-box;
        }
        
        .win-title-input {
            width: 140px; flex-shrink: 0;
            background: transparent; border: 1px solid transparent;
            color: #e2e8f0; font-weight: bold; font-size: 0.85rem;
            padding: 2px 4px; border-radius: 4px; 
            overflow: hidden; text-overflow: ellipsis;
        }
        .win-title-input:hover { border-color: #4a5568; background-color: #2d3748; }
        .win-title-input:focus { border-color: #63b3ed; background-color: #1a202c; outline: none; width: 180px; z-index: 10;}

        .win-drag-area { flex-grow: 1; height: 100%; cursor: move; }

        .btn-header-icon { background: none; border: none; color: #a0aec0; cursor: pointer; font-size: 1rem; padding: 0 4px; }
        .btn-delete { color: #fc8181; font-size: 1.2rem; line-height: 1; border:none; background:none; cursor:pointer;}
        
        .win-body { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        .win-tools { 
            padding: 5px; background-color: #1a202c; display: flex; align-items: center; 
            gap: 4px; flex-shrink: 0; border-bottom: 1px solid #2d3748; flex-wrap: wrap;
            position: relative; z-index: 20;
        }
        textarea {
            flex-grow: 1; width: 100%; background-color: #222630; color: #e2e8f0;
            border: none; padding: 10px; resize: none; line-height: 1.7; outline: none; box-sizing: border-box; 
        }
        .btn-tool { cursor: pointer; border: none; color: #e2e8f0; background-color: #4a5568; border-radius: 3px; padding: 4px 8px; font-size: 0.7rem; white-space: nowrap;}
        .btn-tool:hover { background-color: #718096; }
        .btn-font { font-family: monospace; font-weight: bold; width: 24px; padding: 4px 0; text-align: center; }
        .btn-format { background-color: #553c9a; color: #e9d8fd; }
        .btn-active { background-color: #3182ce; color: white; } /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ç”¨ */

        .mobile-resize-handle {
            height: 12px; background-color: #2d3748; cursor: row-resize; flex-shrink: 0;
            display: none; justify-content: center; align-items: center;
            position: relative; z-index: 20;
        }
        .mobile-resize-handle::after { content: ""; width: 40px; height: 4px; background-color: #4a5568; border-radius: 2px; }
        
        .media-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #000;
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }
        .media-layer.show { display: flex; }
        .media-layer.hidden-media { display: none !important; } /* å¼·åˆ¶éè¡¨ç¤ºç”¨ */
        
        .media-content { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-close-media {
            position: absolute; top: 10px; right: 10px; background-color: rgba(0,0,0,0.6);
            color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 4px 10px; cursor: pointer;
            z-index: 30;
        }

        /* --- Minimal Mode (UIéè¡¨ç¤º) --- */
        body.minimal-mode .win-tools { display: none !important; }
        body.minimal-mode .win-title-input { display: none !important; }
        body.minimal-mode .btn-header-icon { display: none !important; }
        /* ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼è‡ªä½“ã¯ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã«æ®‹ã™ãŒç›®ç«‹ãŸãªãã™ã‚‹ */
        body.minimal-mode .win-header { height: 10px; padding: 0; opacity: 0.2; transition: opacity 0.2s; }
        body.minimal-mode .win-header:hover { opacity: 1; }
        body.minimal-mode .win-header button.btn-delete { display: none; } /* èª¤æ“ä½œé˜²æ­¢ã®ãŸã‚å‰Šé™¤ãƒœã‚¿ãƒ³ã‚‚æ¶ˆã™ */

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (å…±é€š) --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7);
            z-index: 20000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px;
            width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #e2e8f0; margin: 0; border-bottom:1px solid #4a5568; padding-bottom:5px; }
        .modal-body { display: flex; flex-direction: column; gap: 10px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;}
        
        .board-list {
            max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
            background: #1a202c; padding: 10px; border-radius: 4px; min-height: 50px;
        }
        
        .file-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #4a5568; padding: 10px; border-radius: 4px; margin-bottom: 6px;
            transition: background 0.2s;
        }
        .file-row:hover { background-color: #2d3748; border: 1px solid #63b3ed; }
        .file-name { 
            font-weight: bold; color: #e2e8f0; flex-grow: 1; padding-right: 10px; 
            cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .file-actions { display: flex; gap: 8px; }
        .btn-mini {
            padding: 4px 10px; font-size: 0.75rem; border-radius: 3px; border: none; cursor: pointer; color: white;
        }
        .btn-load { background-color: #38a169; }
        .btn-load:hover { background-color: #48bb78; }
        .btn-trash { background-color: #e53e3e; }
        .btn-trash:hover { background-color: #fc8181; }

        .input-group { display: flex; gap: 5px; }
        .input-text {
            background: #1a202c; border: 1px solid #4a5568; color: white;
            padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box;
        }

        .mobile-only { display: none; }
        .pc-only { display: block; }

        @media (max-width: 768px) {
            h1 { display: none; }
            header { gap: 8px; padding: 0 8px; }
            .btn-control { padding: 6px 8px; font-size: 0.75rem; }
            /* ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã—ã¦ã„ãªã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯é€šå¸¸é…ç½® */
            #canvas { padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; overflow-y: auto; }
            
            .window:not(.docked-bottom) { 
                position: relative !important; left: auto !important; top: auto !important; 
                resize: none !important; margin-bottom: 0; z-index: 1 !important; flex-shrink: 0; 
            }
            .window.docked-bottom { z-index: 9999 !important; }
            
            .win-header { cursor: default; }
            .mobile-resize-handle { display: flex; } 
            .mobile-only { display: inline-block; }
            .pc-only { display: none; }
            /* ã‚¹ãƒãƒ›ã§1/2ãƒœã‚¿ãƒ³ãªã©ã‚’ç¢ºå®Ÿã«è¡¨ç¤ºã•ã›ã‚‹ãŸã‚ã®èª¿æ•´ */
            .win-tools { overflow-x: auto; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Canvas v9.0</h1>
        
        <!-- UIéè¡¨ç¤ºãƒœã‚¿ãƒ³ -->
        <button class="btn-control btn-ui-toggle" onclick="toggleMinimalUI()" title="UIè¡¨ç¤ºåˆ‡æ›¿">ğŸ‘ï¸</button>
        <!-- é€£å‹•ã‚¹ã‚¤ãƒƒãƒ -->
        <div class="control-group" style="margin-right:5px;">
             <label class="switch">
                <input type="checkbox" id="syncToggle">
                <span class="slider"></span>
            </label>
            <label for="syncToggle" class="switch-label">é€£å‹•</label>
        </div>

        <!-- åå‰è¡¨ç¤º -->
        <div class="board-indicator">
            ğŸ“ <span id="current-board-name" class="board-name">default</span>
        </div>

        <span id="status-indicator">Ready</span>

        <button class="btn-control btn-cloud" onclick="openCloudModal()">â˜ï¸ æ¥ç¶š</button>

        <div class="control-group">
            <label class="switch">
                <input type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()">
                <span class="slider"></span>
            </label>
            <label for="autoSaveToggle" class="switch-label">Auto</label>
        </div>

        <button class="btn-control" id="btn-manual-save" onclick="manualSaveAll()">ğŸ’¾</button>
        <button class="btn-control" onclick="createNewWindow()">ï¼‹</button>
        <button class="btn-control btn-danger" onclick="clearAllData()">ğŸ—‘ï¸</button>
        
        <div style="width:10px;"></div>

    </header>

    <div id="canvas"></div>

    <!-- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cloudModal" class="modal-overlay" onclick="if(event.target===this) closeModal('cloudModal')">
        <div class="modal-box" style="max-width: 450px;">
            <h3 class="modal-title">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰é€£æº</h3>
            <div class="modal-body">
                <div style="background:#2d3748; padding-bottom:15px; border-bottom:2px dashed #4a5568; margin-bottom:10px;">
                    <p style="margin:0 0 10px 0; font-size:0.9rem; color:#cbd5e0;">
                        ç¾åœ¨ã®ãƒœãƒ¼ãƒ‰: <strong id="cloud-current-name" style="color:#63b3ed; font-size:1.1rem;">default</strong>
                    </p>
                    <button class="btn-control btn-cloud" style="width:100%; padding:10px; margin-bottom:10px; font-size:1rem;" onclick="processUpload(currentBoardName)">
                        â¬†ï¸ ã“ã®åå‰ã§ä¸Šæ›¸ãä¿å­˜
                    </button>
                    <div class="input-group">
                        <input type="text" id="newBoardInput" class="input-text" placeholder="æ–°ã—ã„åå‰ã§ä¿å­˜...">
                        <button class="btn-control" onclick="processUploadNew()">æ–°è¦ä¿å­˜</button>
                    </div>
                </div>
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span style="font-size:0.85rem; color:#a0aec0;">ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:</span>
                        <button class="btn-mini" style="background:none; border:1px solid #4a5568; color:#cbd5e0;" onclick="refreshBoardList()">â†» æ›´æ–°</button>
                    </div>
                    <div id="cloudList" class="board-list" style="height:250px;">
                        <div style="text-align:center; color:#718096; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-control" onclick="closeModal('cloudModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyCsdPclvOpyEyxB4fEklillB729ge_b9-q9afAZPartKazdS9-6u8xkfDercVRaLl2/exec"; 

        const DB_NAME = 'CreativeWorkspaceDB_v7'; 
        const DB_VERSION = 3;
        const STORE_WINDOWS = 'windows';
        const STORE_SETTINGS = 'settings';

        let db = null;
        let zIndexCounter = 100;
        let isAutoSaveEnabled = false;
        let isSaving = false;
        let saveTimers = {};
        let blobCache = {};
        let currentBoardName = "default";
        
        // Minimal Mode State
        let isMinimalMode = false;

        window.onload = async function() {
            await initDB();
            const savedBoard = await getSetting('current_board_name');
            if (savedBoard) currentBoardName = savedBoard;
            const savedAuto = await getSetting('auto_save_enabled');
            if (savedAuto === true) {
                isAutoSaveEnabled = true;
                document.getElementById('autoSaveToggle').checked = true;
                document.getElementById('btn-manual-save').disabled = true;
            }
            updateBoardDisplay();
            loadFromDB();
        };

        // --- UI Toggle ---
        function toggleMinimalUI() {
            isMinimalMode = !isMinimalMode;
            if(isMinimalMode) document.body.classList.add('minimal-mode');
            else document.body.classList.remove('minimal-mode');
        }

        async function getSetting(key) {
            try {
                const tx = db.transaction([STORE_SETTINGS], 'readonly');
                const req = tx.objectStore(STORE_SETTINGS).get(key);
                const res = await new Promise(r => req.onsuccess = () => r(req.result));
                return res ? res.value : null;
            } catch(e) { return null; }
        }
        async function setSetting(key, val) {
            const tx = db.transaction([STORE_SETTINGS], 'readwrite');
            tx.objectStore(STORE_SETTINGS).put({ key: key, value: val });
        }
        async function getAuthPassword() {
            let pass = await getSetting('auth_password');
            if(!pass) {
                pass = prompt("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if(pass) await setSetting('auth_password', pass);
            }
            return pass;
        }
        async function clearAuthPassword() {
            const tx = db.transaction([STORE_SETTINGS], 'readwrite');
            tx.objectStore(STORE_SETTINGS).delete('auth_password');
        }

        function updateBoardDisplay() {
            document.getElementById('current-board-name').textContent = currentBoardName;
            document.getElementById('cloud-current-name').textContent = currentBoardName;
        }

        // --- Cloud Logic ---
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        async function openCloudModal() {
            await manualSaveAll();
            document.getElementById('cloudModal').classList.add('show');
            updateBoardDisplay();
            document.getElementById('newBoardInput').value = "";
            refreshBoardList();
        }
        async function refreshBoardList() {
            const listEl = document.getElementById('cloudList');
            listEl.innerHTML = '<div style="text-align:center; color:#718096; padding:20px;">ä¸€è¦§ã‚’å–å¾—ä¸­...</div>';
            const pass = await getAuthPassword();
            if(!pass) { listEl.innerHTML='<div style="text-align:center;">èªè¨¼ãŒå¿…è¦ã§ã™</div>'; return; }

            try {
                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&action=list`;
                const res = await fetch(url, { method: 'POST' });
                const json = await res.json();

                if(json.status === 'success') {
                    listEl.innerHTML = '';
                    if(json.boards.length === 0) listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#cbd5e0;">ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    else {
                        json.boards.forEach(name => {
                            const div = document.createElement('div');
                            div.className = 'file-row';
                            const isCurrent = (name === currentBoardName);
                            if(isCurrent) div.style.cssText = 'border-left: 3px solid #48bb78; background-color:#2f855a;';
                            div.innerHTML = `
                                <div class="file-name" onclick="processDownload('${name}')">${isCurrent ? 'ğŸ‘‰ ' : 'ğŸ“„ '}${name}</div>
                                <div class="file-actions">
                                    <button class="btn-mini btn-load" onclick="processDownload('${name}')">èª­è¾¼</button>
                                    <button class="btn-mini btn-trash" onclick="deleteBoard('${name}')">å‰Šé™¤</button>
                                </div>
                            `;
                            listEl.appendChild(div);
                        });
                    }
                } else {
                    if(json.message && json.message.includes("åˆè¨€è‘‰")) await clearAuthPassword();
                    throw new Error(json.message);
                }
            } catch(e) { listEl.innerHTML = `<div style="color:#f56565; padding:10px;">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`; }
        }

        async function processUploadNew() {
            const name = document.getElementById('newBoardInput').value.trim();
            if(!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            processUpload(name);
        }

        async function processUpload(boardName) {
            const pass = await getAuthPassword(); if (!pass) return;
            if(!confirm(`ãƒœãƒ¼ãƒ‰ã€Œ${boardName}ã€ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            updateStatus("é€ä¿¡ä¸­...", false);
            try {
                const tx = db.transaction([STORE_WINDOWS], 'readonly');
                const req = tx.objectStore(STORE_WINDOWS).getAll();
                let records = await new Promise(r => req.onsuccess = () => r(req.result));
                records.sort((a,b) => (a.order || 0) - (b.order || 0));

                const exportData = [];
                for(let r of records) {
                    let b64 = null;
                    if(r.hasMedia && r.mediaBlob) b64 = await blobToBase64(r.mediaBlob);
                    exportData.push({
                        id: r.id, title: r.title, order: r.order,
                        layoutPC: r.layoutPC, layoutMobile: r.layoutMobile, fontSize: r.fontSize,
                        text: r.text, hasMedia: r.hasMedia, mediaType: r.mediaType, mediaBase64: b64
                    });
                }
                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&boardName=${encodeURIComponent(boardName)}`;
                const res = await fetch(url, { method: 'POST', body: JSON.stringify(exportData) });
                const json = await res.json();
                
                if(json.status === 'success') { 
                    currentBoardName = boardName;
                    await setSetting('current_board_name', currentBoardName);
                    updateBoardDisplay(); document.getElementById('newBoardInput').value = "";
                    updateStatus("ä¿å­˜å®Œäº†", true); alert(`ä¿å­˜å®Œäº†: ${currentBoardName}`);
                    refreshBoardList(); 
                } else throw new Error(json.message);
            } catch(e) { console.error(e); updateStatus("UPå¤±æ•—", false, true); alert(e.message); }
        }

        async function deleteBoard(boardName) {
            if(!confirm(`ã€Œ${boardName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            updateStatus("å‰Šé™¤ä¸­...", false);
            const pass = await getAuthPassword();
            try {
                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&action=delete&boardName=${encodeURIComponent(boardName)}`;
                const res = await fetch(url, { method: 'POST' });
                const json = await res.json();
                if(json.status === 'success') { updateStatus("å‰Šé™¤å®Œäº†", true); refreshBoardList(); }
                else throw new Error(json.message);
            } catch(e) { alert("å‰Šé™¤å¤±æ•—: " + e.message); updateStatus("å‰Šé™¤å¤±æ•—", false, true); }
        }

        // ä¿®æ­£ç‰ˆ processDownload (Promise.allå¯¾å¿œ)
        async function processDownload(boardName) {
            if(!confirm(`ãƒœãƒ¼ãƒ‰ã€Œ${boardName}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n(ç¾åœ¨ã®ä½œæ¥­å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™)`)) return;
            updateStatus("å—ä¿¡ä¸­...", false);
            const pass = await getAuthPassword(); 
            try {
                const url = `${GAS_API_URL}?auth=${encodeURIComponent(pass)}&action=download&boardName=${encodeURIComponent(boardName)}`;
                const res = await fetch(url, { method: 'POST', body: "" });
                const text = await res.text();
                let importData;
                try { importData = JSON.parse(text); } catch(e) { throw new Error("JSON Parse Error"); }
                if (importData.status === 'error') throw new Error(importData.message);

                await clearAllData(true); 

                const savePromises = [];
                for(let i=0; i<importData.length; i++) {
                    let r = importData[i];
                    let blob = null;
                    if(r.hasMedia && r.mediaBase64) blob = await base64ToBlob(r.mediaBase64);
                    if(blob) blobCache[r.id] = { blob: blob, type: r.mediaType };
                    
                    let lPC = r.layoutPC || { x: r.x||'50px', y: r.y||'50px', w: r.w||'320px', h: r.h||'400px', z: r.z||100 };
                    let lMob = r.layoutMobile || { h: '350px', w: '100%' };
                    let fSize = r.fontSize || '14px';
                    let title = r.title || `Window ${r.id}`;
                    let order = (r.order !== undefined) ? r.order : i;
                    
                    const record = {
                        id: r.id, title: title, order: order,
                        layoutPC: lPC, layoutMobile: lMob, fontSize: fSize,
                        text: r.text, hasMedia: r.hasMedia, mediaBlob: blob, mediaType: r.mediaType
                    };
                    
                    const p = new Promise((resolve, reject) => {
                        const tx = db.transaction([STORE_WINDOWS], 'readwrite');
                        tx.objectStore(STORE_WINDOWS).put(record);
                        tx.oncomplete = () => resolve();
                        tx.onerror = (e) => reject(e);
                    });
                    savePromises.push(p);
                }

                await Promise.all(savePromises);

                currentBoardName = boardName;
                await setSetting('current_board_name', currentBoardName);
                
                updateBoardDisplay();
                loadFromDB(); 
                
                closeModal('cloudModal'); 
                updateStatus("èª­è¾¼å®Œäº†", true);
                alert(`èª­ã¿è¾¼ã¿å®Œäº†: ${boardName}`);
            } catch(e) { console.error(e); updateStatus("DOWNå¤±æ•—", false, true); alert(e.message); }
        }

        // --- Common Utils ---
        function blobToBase64(blob) { return new Promise((r,j)=>{const z=new FileReader();z.onloadend=()=>r(z.result);z.onerror=j;z.readAsDataURL(blob);}); }
        async function base64ToBlob(b64) { const r=await fetch(b64); return await r.blob(); }

        function initDB() {
            return new Promise((resolve, reject) => {
                const r = indexedDB.open(DB_NAME, DB_VERSION);
                r.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains(STORE_WINDOWS)) d.createObjectStore(STORE_WINDOWS, { keyPath: 'id' });
                    if (!d.objectStoreNames.contains(STORE_SETTINGS)) d.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                };
                r.onsuccess = (e) => { db = e.target.result; resolve(db); };
                r.onerror = (e) => reject(e);
            });
        }
        
        async function saveWindowToDB(winId) {
            if (!db) return;
            const el = document.getElementById(winId); if (!el) return;
            const idNum = parseInt(winId.split('-')[1]);
            const isMobile = window.innerWidth <= 768;
            
            const ta = el.querySelector('textarea');
            const titleInput = el.querySelector('.win-title-input');
            
            // ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã®ãƒ¡ãƒ‡ã‚£ã‚¢ä¿æŒåˆ¤å®š
            const hasMediaContent = !!blobCache[idNum]; 
            let blob = null, type = null;
            if (hasMediaContent) { blob = blobCache[idNum].blob; type = blobCache[idNum].type; }
            
            const allWins = Array.from(document.getElementById('canvas').children);
            const myOrder = allWins.indexOf(el);

            const tx = db.transaction([STORE_WINDOWS], 'readonly');
            const old = await new Promise(r => { const req = tx.objectStore(STORE_WINDOWS).get(idNum); req.onsuccess = () => r(req.result); });
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            let layoutPC = (old && old.layoutPC) ? old.layoutPC : { x:'50px', y:'50px', w:'320px', h:'400px', z:100, fontSize: '14px' };
            let layoutMobile = (old && old.layoutMobile) ? old.layoutMobile : { h:'350px', w:'100%', fontSize: '14px', dockedHeight: '250px' };
            
            let currentFontSize = el.style.getPropertyValue('--font-size') || '14px';
            const isDocked = el.classList.contains('docked-bottom');
            layoutMobile.isDocked = isDocked;

            if (isMobile) { 
                if(isDocked) {
                    // ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä¸­ã¯ã€ç¾åœ¨ã®é«˜ã•ã‚’ãƒ‰ãƒƒã‚­ãƒ³ã‚°å°‚ç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜
                    layoutMobile.dockedHeight = el.style.height;
                } else {
                    // é€šå¸¸æ™‚ã¯é€šå¸¸ã®é«˜ã•ãƒ»å¹…ã‚’ä¿å­˜
                    layoutMobile.h = el.style.height; 
                    layoutMobile.w = el.style.width; 
                }
                layoutMobile.fontSize = currentFontSize;
            } else { 
                layoutPC.x = el.style.left; layoutPC.y = el.style.top; 
                layoutPC.w = el.style.width; layoutPC.h = el.style.height; 
                layoutPC.z = parseInt(el.style.zIndex || 100);
                layoutPC.fontSize = currentFontSize;
            }
            
            const data = {
                id: idNum, title: titleInput.value, order: myOrder,
                layoutPC: layoutPC, layoutMobile: layoutMobile, 
                fontSize: currentFontSize, 
                text: ta.value, hasMedia: hasMediaContent, mediaBlob: blob, mediaType: type
            };

            return new Promise(res => {
                const tx2 = db.transaction([STORE_WINDOWS], 'readwrite');
                tx2.objectStore(STORE_WINDOWS).put(data);
                tx2.oncomplete = () => { updateStatus('ä¿å­˜æ¸ˆ', true); res(); };
            });
        }
        async function deleteWindowFromDB(id) {
            if(!db) return;
            const tx = db.transaction([STORE_WINDOWS], 'readwrite');
            tx.objectStore(STORE_WINDOWS).delete(id);
            delete blobCache[id];
        }
        async function loadFromDB() {
            if(!db) return;
            document.getElementById('canvas').innerHTML = '';
            const tx = db.transaction([STORE_WINDOWS], 'readonly');
            const req = tx.objectStore(STORE_WINDOWS).getAll();
            req.onsuccess = (e) => {
                let r = e.target.result;
                r.sort((a,b) => { if (a.order !== undefined && b.order !== undefined) return a.order - b.order; return a.id - b.id; });
                if(r.length===0){ addWindow(50,50,1); addWindow(400,50,2); }
                else r.forEach(rec => restoreWindow(rec));
                updateStatus('Ready', true);
            };
        }
        async function clearAllData(skip=false) {
            if(!skip && !confirm("å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            document.getElementById('canvas').innerHTML=''; blobCache={};
            const tx = db.transaction([STORE_WINDOWS], 'readwrite');
            tx.objectStore(STORE_WINDOWS).clear();
            if(!skip) updateStatus('å‰Šé™¤å®Œäº†', true);
        }
        async function toggleAutoSave() { 
            isAutoSaveEnabled = document.getElementById('autoSaveToggle').checked; 
            document.getElementById('btn-manual-save').disabled = isAutoSaveEnabled;
            await setSetting('auto_save_enabled', isAutoSaveEnabled);
        }
        function notifyChange(winId) {
            if (!isAutoSaveEnabled) return;
            if (saveTimers[winId]) clearTimeout(saveTimers[winId]);
            updateStatus('å¤‰æ›´...', false);
            saveTimers[winId] = setTimeout(async () => {
                if(isSaving) { notifyChange(winId); return; }
                isSaving=true;
                try { await saveWindowToDB(winId); } finally { isSaving=false; delete saveTimers[winId]; }
            }, 1000);
        }
        async function manualSaveAll() {
            if(isSaving) return;
            isSaving=true; document.getElementById('btn-manual-save').disabled=true;
            updateStatus('ä¿å­˜ä¸­...', false);
            const wins=document.querySelectorAll('.window');
            for(const w of wins) await saveWindowToDB(w.id);
            isSaving=false; updateStatus('ä¿å­˜å®Œäº†', true);
            if(!isAutoSaveEnabled) document.getElementById('btn-manual-save').disabled=false;
        }
        function updateStatus(m,s,e=false) {
            const el=document.getElementById('status-indicator'); el.textContent=m; el.className='';
            if(s) el.classList.add('saved'); if(e) el.classList.add('error');
        }
        function createNewWindow() {
            let max=0; document.querySelectorAll('.window').forEach(w=>{ const id=parseInt(w.id.split('-')[1]); if(id>max) max=id; });
            addWindow(50,50,max+1);
        }
        function addWindow(x,y,idNum, layoutPC=null, layoutMobile=null, fontSize=null, title=null) {
            const winId='win-'+idNum;
            const isMobile = window.innerWidth <= 768;
            const initialTitle = title || `Window ${idNum}`;
            
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—
            let styleStr = "";
            let w = '320px', h = '400px', z = null;
            let isDocked = false;
            let targetFontSize = fontSize || '14px';

            if (isMobile) {
                // é€šå¸¸æ™‚ã®é«˜ã•
                h = (layoutMobile && layoutMobile.h) ? layoutMobile.h : '350px';
                
                // ãƒ‰ãƒƒã‚­ãƒ³ã‚°æ™‚ã®é«˜ã•ï¼ˆä¿å­˜ã•ã‚Œã¦ãªã‘ã‚Œã°250pxï¼‰
                let dockedH = (layoutMobile && layoutMobile.dockedHeight) ? layoutMobile.dockedHeight : '250px';

                let wMob = (layoutMobile && layoutMobile.w) ? layoutMobile.w : '100%';
                if(layoutMobile && layoutMobile.isDocked) isDocked = true;
                
                if (!fontSize && layoutMobile && layoutMobile.fontSize) targetFontSize = layoutMobile.fontSize;
                
                // ã‚‚ã—ãƒ‰ãƒƒã‚­ãƒ³ã‚°çŠ¶æ…‹ãªã‚‰ã€é«˜ã•ã¯ dockedH ã‚’ä½¿ã†
                let applyH = isDocked ? dockedH : h;

                styleStr = `height:${applyH}; width:${wMob}; --font-size:${targetFontSize};`;
            } else {
                if (layoutPC) { x = layoutPC.x; y = layoutPC.y; w = layoutPC.w; h = layoutPC.h; z = layoutPC.z; }
                if (!fontSize && layoutPC && layoutPC.fontSize) targetFontSize = layoutPC.fontSize;
                if(z===null || z===undefined){ zIndexCounter++; z=zIndexCounter; }
                else if(z>zIndexCounter) zIndexCounter=z;
                styleStr = `left:${x}; top:${y}; width:${w}; height:${h}; z-index:${z}; --font-size:${targetFontSize};`;
            }
            
            const div=document.createElement('div');
            div.className='window' + (isDocked ? ' docked-bottom' : '');
            div.id=winId; div.style.cssText = styleStr;
            
            // ãƒ‰ãƒƒã‚­ãƒ³ã‚°æ™‚ãªã‚‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä½™ç™½ã‚‚ãã®é«˜ã•åˆ†ç¢ºä¿
            if(isDocked) updateCanvasPadding(parseInt(div.style.height, 10));

            const widthBtnLabel = (div.style.width === '100%' || !div.style.width) ? '1/2' : 'Full';
            const dockBtnClass = isDocked ? 'btn-active' : '';

            // â˜…ä¿®æ­£: ä¸Šéƒ¨ã® dock-resize-handle ã®HTMLè¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ
            div.innerHTML=`
                <div class="win-header" onmousedown="startDrag(event,'${winId}')">
                    <button class="btn-header-icon mobile-only" onclick="moveWindow('${winId}', -1)">â†‘</button>
                    <button class="btn-header-icon mobile-only" onclick="moveWindow('${winId}', 1)">â†“</button>
                    <input type="text" class="win-title-input" value="${initialTitle}" onchange="notifyChange('${winId}')" onmousedown="event.stopPropagation()">
                    <div class="win-drag-area"></div>
                    <button class="btn-delete" onclick="removeWindow('${winId}')">Ã—</button>
                </div>
                <div class="win-body" onmousedown="bringToFront('${winId}')" ondragover="handleDragOver(event,this)" ondragleave="handleDragLeave(event,this)" ondrop="handleDrop(event,'${winId}')">
                    <div class="win-tools">
                        <div class="tools-text-group">
                            <button class="btn-tool" onclick="pasteToArea(${idNum})">Paste</button>
                            <button class="btn-tool btn-format" onclick="formatContent(${idNum})">æ•´å½¢</button>
                            <div style="width:5px;"></div>
                            <button class="btn-tool btn-font" onclick="changeFontSize(${idNum}, -2)">A-</button>
                            <button class="btn-tool" onclick="resetFontSize(${idNum})" title="Reset">Def</button>
                            <button class="btn-tool btn-font" onclick="changeFontSize(${idNum}, 2)">A+</button>
                        </div>

                        <div style="flex-grow:1;"></div>
                        
                        <button class="btn-tool btn-danger" id="btn-media-del-${idNum}" onclick="closeMedia(${idNum})" title="ãƒ¡ãƒ‡ã‚£ã‚¢å‰Šé™¤" style="display:none; padding:4px 6px;">ğŸ—‘ï¸</button>
                        <button class="btn-tool" id="btn-media-toggle-${idNum}" onclick="toggleMediaVisibility(${idNum})" title="è¡¨ç¤ºåˆ‡æ›¿" style="display:none;">ğŸ¬</button>

                        <button class="btn-tool mobile-only" id="btn-width-${idNum}" onclick="toggleMobileWidth(${idNum})">${widthBtnLabel}</button>
                        <button class="btn-tool mobile-only ${dockBtnClass}" id="btn-dock-${idNum}" onclick="toggleDock(${idNum})" title="ç”»é¢ä¸‹ã«å›ºå®š">âš“</button>
                    </div>
                    
                    <textarea id="text-${idNum}" style="font-size:${targetFontSize};" oninput="notifyChange('${winId}')"></textarea>
                    
                    <div id="media-${idNum}" class="media-layer">
                        <div id="media-content-${idNum}" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div>
                    </div>
                    
                    <div class="mobile-resize-handle" onmousedown="event.stopPropagation()" ontouchstart="startMobileResize(event, '${winId}')"></div>
                </div>`;
            
            document.getElementById('canvas').appendChild(div);

            div.addEventListener('mouseup', ()=> { if(currentDragWin!==div) notifyChange(winId); });
            div.querySelector('textarea').addEventListener('scroll', (e)=>{ if(document.getElementById('syncToggle').checked) { const t=e.target.scrollTop; document.querySelectorAll('textarea').forEach(ta=>{ if(ta!==e.target && ta.offsetParent) ta.scrollTop=t; }); } });
            
            if(!isDocked) bringToFront(winId);
            return div;
        }
        function restoreWindow(r) {
            // äº’æ›æ€§ã®ãŸã‚å¤ã„fontSizeã‚‚è€ƒæ…®ã—ã¤ã¤ã€addWindowå´ã§åˆ¤æ–­ã•ã›ã‚‹ãŸã‚nullã‚’æ¸¡ã™ã‹æ¤œè¨
            // ã“ã“ã§ã¯ã‚ãˆã¦æ˜ç¤ºçš„ã« layoutPC/layoutMobile ã‚’æ¸¡ã™ã ã‘ã«ç•™ã‚ã‚‹
            // ï¼ˆaddWindowå†…ã§ isMobile åˆ¤å®šã‚’è¡Œã„ã€é©åˆ‡ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¡ç”¨ã™ã‚‹ï¼‰
            
            let lPC = r.layoutPC || { x:r.x, y:r.y, w:r.w, h:r.h, z:r.z, fontSize: r.fontSize };
            // å¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã¯ layoutMobile ãŒãªã„å ´åˆãŒã‚ã‚‹ã®ã§è£œå®Œ
            let lMob = r.layoutMobile || { h: '350px', w: '100%', fontSize: r.fontSize };

            // ç¬¬6å¼•æ•°(fontSize)ã¯ null ã‚’æ¸¡ã—ã¦ addWindow å†…ã®ãƒ­ã‚¸ãƒƒã‚¯ã«ä»»ã›ã‚‹
            const w = addWindow(0,0,r.id, lPC, lMob, null, r.title);
            
            if(r.text) w.querySelector('textarea').value=r.text;
            if(r.hasMedia && r.mediaBlob) { 
                blobCache[r.id]={blob:r.mediaBlob, type:r.mediaType}; 
                showMedia(r.id, r.mediaBlob, r.mediaType); 
            }
        }
        function removeWindow(id) { 
            if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ 
                const el=document.getElementById(id); 
                if(el){ 
                    // ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã—ã¦ã„ãŸã‚‰è§£é™¤ã—ã¦ä½™ç™½æˆ»ã™
                    if(el.classList.contains('docked-bottom')) updateCanvasPadding(0);
                    el.remove(); 
                    deleteWindowFromDB(parseInt(id.split('-')[1])); 
                } 
            } 
        }
        
        // --- Mobile Logic ---
    // --- Dock Resize Logic (æ–°è¦è¿½åŠ ãƒ»ä¿®æ­£ç‰ˆ) --- 
        let dockingWin = null;
        let dockStartY = 0;
        let dockStartH = 0;

        function startDockResize(e, winId) {
            // ã“ã“ã§ã® preventDefault ã¯å‰Šé™¤ï¼ˆtouch-action: none ã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ï¼‰
            // e.preventDefault(); 
            // e.stopPropagation();
            
            dockingWin = document.getElementById(winId);
            if (!dockingWin) return;

            const touch = e.touches[0];
            dockStartY = touch.clientY;
            
            // ç¾åœ¨ã®é«˜ã•ã‚’å–å¾—ï¼ˆpaddingç­‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã‚’è€ƒæ…®ã—ã¦ computedStyle ã‚’ä½¿ç”¨ï¼‰
            const style = window.getComputedStyle(dockingWin);
            dockStartH = parseInt(style.height, 10);
            
            if (isNaN(dockStartH)) dockStartH = 350; // ä¸‡ãŒä¸€å–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

            // touchmove ã¯ preventDefault ãŒå¿…è¦ãªãŸã‚ passive: false ã‚’æ˜ç¤º
            document.addEventListener('touchmove', onDockResizeMove, {passive: false});
            document.addEventListener('touchend', onDockResizeEnd);
        }

        function onDockResizeMove(e) {
            if (!dockingWin) return;
            
            // ã“ã“ã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºå®Ÿã«æ­¢ã‚ã‚‹ãŸã‚ã« preventDefault ã™ã‚‹
            if (e.cancelable) e.preventDefault();

            const touch = e.touches[0];
            // ä¸Šã«å¼•ã£å¼µã‚‹ï¼ˆYãŒæ¸›ã‚‹ï¼‰ã¨é«˜ã•ãŒå¢—ãˆã‚‹è¨ˆç®—
            const diff = dockStartY - touch.clientY; 
            let newH = dockStartH + diff;

            // æœ€å°ãƒ»æœ€å¤§é«˜ã•ã®åˆ¶é™
            if (newH < 150) newH = 150;
            // ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ç­‰ã®å½±éŸ¿ã‚’è€ƒæ…®ã—ã¦å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹
            if (newH > window.innerHeight - 50) newH = window.innerHeight - 50;

            dockingWin.style.height = newH + 'px';
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä½™ç™½ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€£å‹•ã•ã›ã‚‹
            updateCanvasPadding(newH);
        }
        function onDockResizeEnd(e) {
            if (dockingWin) {
                notifyChange(dockingWin.id); // ä¿å­˜ãƒˆãƒªã‚¬ãƒ¼
                // æœ€çµ‚çš„ãªé«˜ã•ã§ä½™ç™½ã‚’ç¢ºå®š
                updateCanvasPadding(parseInt(dockingWin.style.height, 10));
            }
            dockingWin = null;
            document.removeEventListener('touchmove', onDockResizeMove);
            document.removeEventListener('touchend', onDockResizeEnd);
        }

        function toggleMobileWidth(idNum) { 
            const win = document.getElementById(`win-${idNum}`); 
            const btn = document.getElementById(`btn-width-${idNum}`); 
            const currentW = win.style.width; 
            if (currentW === '100%' || !currentW) { win.style.width = 'calc(50% - 5px)'; btn.textContent = 'Full'; } 
            else { win.style.width = '100%'; btn.textContent = '1/2'; } 
            notifyChange(`win-${idNum}`); 
        }

        // Dock Logic
        async function toggleDock(idNum) {
            const winId = `win-${idNum}`;
            const win = document.getElementById(winId);
            const btn = document.getElementById(`btn-dock-${idNum}`);
            const wasDocked = win.classList.contains('docked-bottom');

            // ä»–ã«ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã—ã¦ã„ã‚‹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒã‚ã‚Œã°è§£é™¤
            document.querySelectorAll('.window.docked-bottom').forEach(w => {
                w.classList.remove('docked-bottom');
                // è§£é™¤æ™‚ã¯é«˜ã•ã‚’æ±ç”¨ã®350pxãªã©ã«æˆ»ã™ï¼ˆã¾ãŸã¯ä¿æŒã—ã¦ã„ãŸå€¤ã«æˆ»ã™ï¼‰
                // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«350pxã«æˆ»ã™è¨­å®šã«ã—ã¾ã™
                w.style.height = '350px'; 
                
                const oid = w.id.split('-')[1];
                const b = document.getElementById(`btn-dock-${oid}`);
                if(b) b.classList.remove('btn-active');
            });

            if(!wasDocked) {
                // --- ãƒ‰ãƒƒã‚­ãƒ³ã‚°é–‹å§‹ ---
                
                // DBã‹ã‚‰å‰å›ä¿å­˜ã—ãŸãƒ‰ãƒƒã‚­ãƒ³ã‚°æ™‚ã®é«˜ã•ã‚’å–å¾—ã—ã¦ã¿ã‚‹
                let savedDockH = '250px';
                try {
                    const tx = db.transaction([STORE_WINDOWS], 'readonly');
                    const r = await new Promise(resolve => {
                        const req = tx.objectStore(STORE_WINDOWS).get(idNum);
                        req.onsuccess = () => resolve(req.result);
                    });
                    if(r && r.layoutMobile && r.layoutMobile.dockedHeight) {
                        savedDockH = r.layoutMobile.dockedHeight;
                    }
                } catch(e) {}

                win.classList.add('docked-bottom');
                win.style.height = savedDockH; // ä¿å­˜ã•ã‚ŒãŸé«˜ã•ã€ã¾ãŸã¯250px
                
                btn.classList.add('btn-active');
                updateCanvasPadding(parseInt(savedDockH, 10));
            } else {
                // --- ãƒ‰ãƒƒã‚­ãƒ³ã‚°è§£é™¤ ---
                win.style.height = '350px'; // é€šå¸¸æ™‚ã®é«˜ã•ã«æˆ»ã™
                updateCanvasPadding(0);
            }
            notifyChange(winId);
        }
        function updateCanvasPadding(px) {
            // ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä¸­ãªã‚‰ +80pxï¼ˆä»Šã¾ã§é€šã‚Šï¼‰ã€ãã†ã§ãªã‘ã‚Œã° 200pxï¼ˆãŸã£ã·ã‚Šï¼‰
            const buffer = (px > 0) ? 80 : 200;
            document.getElementById('canvas').style.paddingBottom = (px + buffer) + 'px';
        }

        function toggleMediaVisibility(idNum) {
            const layer = document.getElementById(`media-${idNum}`);
            const win = document.getElementById(`win-${idNum}`);
            
            layer.classList.toggle('hidden-media');
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢ãŒéš ã•ã‚ŒãŸã‚‰ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã‚’å¾©æ´»ã•ã›ã‚‹ï¼ˆmedia-modeã‚’å¤–ã™ï¼‰
            // ãƒ¡ãƒ‡ã‚£ã‚¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã‚’éš ã™ï¼ˆmedia-modeã‚’ä»˜ã‘ã‚‹ï¼‰
            if(layer.classList.contains('hidden-media')) {
                win.classList.remove('media-mode');
            } else {
                win.classList.add('media-mode');
            }
        }
        
        // --- Resize/Font ---
        let resizingWin = null; let startTouchY = 0; let startHeight = 0;
        function startMobileResize(e, winId) { e.preventDefault(); resizingWin = document.getElementById(winId); const touch = e.touches[0]; startTouchY = touch.clientY; startHeight = parseInt(window.getComputedStyle(resizingWin).height, 10); document.addEventListener('touchmove', onMobileResizeMove, {passive: false}); document.addEventListener('touchend', onMobileResizeEnd); }
        function onMobileResizeMove(e) { if (!resizingWin) return; e.preventDefault(); const touch = e.touches[0]; const newH = startHeight + (touch.clientY - startTouchY); if (newH > 100) resizingWin.style.height = newH + 'px'; }
        function onMobileResizeEnd(e) { if (resizingWin) notifyChange(resizingWin.id); resizingWin = null; document.removeEventListener('touchmove', onMobileResizeMove); document.removeEventListener('touchend', onMobileResizeEnd); }
        function changeFontSize(idNum, delta) { const ta = document.getElementById(`text-${idNum}`); const win = document.getElementById(`win-${idNum}`); if(!ta) return; let current = parseInt(win.style.getPropertyValue('--font-size') || "14"); let next = current + delta; if(next < 10) next = 10; if(next > 60) next = 60; const sizeStr = next + "px"; ta.style.fontSize = sizeStr; win.style.setProperty('--font-size', sizeStr); notifyChange(`win-${idNum}`); }
        function resetFontSize(idNum) { const ta = document.getElementById(`text-${idNum}`); const win = document.getElementById(`win-${idNum}`); if(!ta) return; ta.style.fontSize = "14px"; win.style.setProperty('--font-size', "14px"); notifyChange(`win-${idNum}`); }
        
        // --- Drag & Paste ---
        let currentDragWin=null, dx=0, dy=0;
        function startDrag(e,id) { 
            const w=document.getElementById(id);
            if(w.classList.contains('docked-bottom')) return; // ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä¸­ã¯ç§»å‹•ä¸å¯
            if(e.target.tagName==='INPUT' || e.target.tagName==='BUTTON') return; 
            if(window.innerWidth<=768)return; 
            bringToFront(id); currentDragWin=w; dx=e.clientX-w.offsetLeft; dy=e.clientY-w.offsetTop; document.addEventListener('mousemove',onMouseMove); document.addEventListener('mouseup',onMouseUp); 
        }
        function onMouseMove(e){ if(!currentDragWin)return; let nx=e.clientX-dx, ny=e.clientY-dy; if(ny<0)ny=0; currentDragWin.style.left=nx+'px'; currentDragWin.style.top=ny+'px'; }
        function onMouseUp(){ if(currentDragWin) notifyChange(currentDragWin.id); currentDragWin=null; document.removeEventListener('mousemove',onMouseMove); document.removeEventListener('mouseup',onMouseUp); }
        
        function bringToFront(id){ const w=document.getElementById(id); zIndexCounter++; w.style.zIndex=zIndexCounter; document.querySelectorAll('.window').forEach(e=>e.classList.remove('active')); w.classList.add('active'); notifyChange(id); }
        function moveWindow(winId, dir) { const el = document.getElementById(winId); const parent = el.parentNode; if (dir === -1) { if (el.previousElementSibling) { parent.insertBefore(el, el.previousElementSibling); manualSaveAll(); } } else { if (el.nextElementSibling) { parent.insertBefore(el.nextElementSibling, el); manualSaveAll(); } } }

        async function pasteToArea(id){ try{ const t=await navigator.clipboard.readText(); const ta=document.getElementById('text-'+id); const start = ta.selectionStart; const end = ta.selectionEnd; const val = ta.value; ta.value = val.substring(0, start) + t + val.substring(end); notifyChange('win-'+id); }catch(e){alert('ãƒšãƒ¼ã‚¹ãƒˆæ¨©é™ãªã—');} }
        function formatContent(id){ 
            const ta=document.getElementById('text-'+id); 
            let t=ta.value; 
            if(!t)return; 
            
            // 1. æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã®æ­£è¦åŒ–
            t = t.replace(/\r\n/g,'\n');

            // 2. ã€ä»Šå›è¿½åŠ ã€‘ç©ºç™½è¡Œã‚’å‰Šé™¤ï¼ˆ2ã¤ä»¥ä¸Šé€£ç¶šã™ã‚‹æ”¹è¡Œã‚’1ã¤ã«ã™ã‚‹ï¼‰
            t = t.replace(/\n{2,}/g, '\n');

            // 3. æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ«ï¼ˆã‚·ãƒ¼ãƒ³åŒºåˆ‡ã‚Šã®ã€ ã€‘ã®å‰ã ã‘ã¯ã‚ãˆã¦ç©ºè¡Œã‚’å…¥ã‚Œã‚‹ä»•æ§˜ã¯ç¶­æŒï¼‰
            t = t.replace(/([^\n])(ã€)/g,'$1\n\n$2') 
                 .replace(/\s+(\d+\.)/g,'\n$1')
                 .replace(/([^\n])(ã€Œ)/g,(m,p1,p2)=> /[\d\.\s]/.test(p1)?m:p1+'\n'+p2)
                 .replace(/(ã€)(\s+)(\d+\.)/g,'$1\n$3'); 
            
            ta.value=t; 
            notifyChange('win-'+id); 
        }
        
        function showMedia(id,blob,type) { 
            const c=document.getElementById(`media-content-${id}`); c.innerHTML=''; 
            const url=URL.createObjectURL(blob); let el; 
            if(type.startsWith('image/')) { el=document.createElement('img'); el.src=url; } 
            else if(type.startsWith('video/')) { el=document.createElement('video'); el.src=url; el.controls=true; el.loop=true; el.muted=true; el.playsInline=true; } 
            if(el){ 
                el.className='media-content'; c.appendChild(el); 
                const layer = document.getElementById(`media-${id}`);
                layer.classList.add('show');
                layer.classList.remove('hidden-media'); // è¡¨ç¤ºæ™‚ã¯å¼·åˆ¶çš„ã«hiddenè§£é™¤
                
                // â˜…UIåˆ¶å¾¡: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¯ãƒ©ã‚¹ä»˜ä¸ã—ã¦ãƒ„ãƒ¼ãƒ«ã‚’éš ã™
                document.getElementById(`win-${id}`).classList.add('media-mode');

                document.getElementById(`btn-media-toggle-${id}`).style.display = 'inline-block';
                document.getElementById(`btn-media-del-${id}`).style.display = 'inline-block';
            } 
        }
        function handleDragOver(e,el){ e.preventDefault(); e.stopPropagation(); el.closest('.window').classList.add('drag-over-active'); }
        function handleDragLeave(e,el){ e.preventDefault(); e.stopPropagation(); el.closest('.window').classList.remove('drag-over-active'); }
        function handleDrop(e,winId){ e.preventDefault(); e.stopPropagation(); document.getElementById(winId).classList.remove('drag-over-active'); const f=e.dataTransfer.files[0]; if(!f)return; const id=parseInt(winId.split('-')[1]); blobCache[id]={blob:f, type:f.type}; showMedia(id,f,f.type); notifyChange(winId); }
        function closeMedia(id){ 
            if(!confirm("ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            document.getElementById(`media-${id}`).classList.remove('show');
            document.getElementById(`media-${id}`).classList.remove('hidden-media');
            
            const c=document.getElementById(`media-content-${id}`); 
            if(c.firstChild) URL.revokeObjectURL(c.firstChild.src); 
            c.innerHTML=''; 
            delete blobCache[id]; 
            
            // â˜…UIåˆ¶å¾¡: ã‚¯ãƒ©ã‚¹é™¤å»ã—ã¦ãƒ„ãƒ¼ãƒ«ã‚’å†è¡¨ç¤º
            document.getElementById(`win-${id}`).classList.remove('media-mode');

            document.getElementById(`btn-media-toggle-${id}`).style.display = 'none';
            document.getElementById(`btn-media-del-${id}`).style.display = 'none';
            
            notifyChange('win-'+id); 
        }
    </script>
</body>
</html>
